<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>Validade</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
:root{--bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#252540;--text:#e8e8f0;--text2:#9999b0;--accent:#6c5ce7;--accent2:#a855f7;--green:#00b894;--yellow:#fdcb6e;--orange:#e17055;--red:#d63031;--card:#1e1e35;--radius:16px;--shadow:0 4px 20px rgba(0,0,0,.3);--transition:.3s cubic-bezier(.4,0,.2,1)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:130px;transition:background var(--transition),color var(--transition)}
body.light{--bg:#f5f5ff;--bg2:#eeeef8;--bg3:#e0e0ee;--text:#1a1a2e;--text2:#666680;--card:#fff;--shadow:0 4px 20px rgba(0,0,0,.08)}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}

.header{padding:16px 20px 8px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:24px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800}
.header-actions{display:flex;gap:8px}
.header-btn{background:var(--bg2);border:none;color:var(--text);width:40px;height:40px;border-radius:12px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.header-btn:active{transform:scale(.9)}

.page{display:none;padding:0 16px 140px;animation:fadeIn .3s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes sparkle{0%,100%{opacity:1}50%{opacity:.5}}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);backdrop-filter:blur(20px);display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.05);z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 16px;border:none;background:none;color:var(--text2);font-size:10px;cursor:pointer;transition:var(--transition);border-radius:12px}
.nav-item .icon{font-size:22px;transition:var(--transition)}
.nav-item.active{color:var(--accent)}
.nav-item.active .icon{transform:scale(1.15)}
.nav-item:active{transform:scale(.9)}

.card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);transition:var(--transition);position:relative;overflow:hidden}
.card:active{transform:scale(.98)}
.section-title{font-size:14px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin:20px 0 12px;display:flex;align-items:center;gap:8px}

.alert-card{padding:16px;border-radius:var(--radius);margin-bottom:12px;display:flex;align-items:center;gap:12px;animation:slideUp .4s ease}
.alert-card.red{background:linear-gradient(135deg,rgba(214,48,49,.2),rgba(214,48,49,.05));border-left:4px solid var(--red)}
.alert-card.orange{background:linear-gradient(135deg,rgba(225,112,85,.2),rgba(225,112,85,.05));border-left:4px solid var(--orange)}
.alert-card.yellow{background:linear-gradient(135deg,rgba(253,203,110,.15),rgba(253,203,110,.05));border-left:4px solid var(--yellow)}
.alert-card .alert-icon{font-size:32px}
.alert-card .alert-info{flex:1}
.alert-card .alert-info h3{font-size:15px;margin-bottom:2px}
.alert-card .alert-info p{font-size:12px;color:var(--text2)}
.alert-count{background:var(--red);color:#fff;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700}

.streak-card{background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:var(--radius);padding:20px;text-align:center;margin-bottom:16px;position:relative;overflow:hidden}
.streak-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 60%);animation:pulse 3s infinite}
.streak-num{font-size:48px;font-weight:900}
.streak-label{font-size:13px;opacity:.9;margin-top:4px}
.streak-fire{font-size:28px}

.recipe-card{background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(168,85,247,.1));border-radius:var(--radius);padding:16px;margin-bottom:12px;border:1px solid rgba(108,92,231,.2)}
.recipe-card h3{font-size:16px;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.recipe-card p{font-size:13px;color:var(--text2);line-height:1.5}
.recipe-card .recipe-steps{margin-top:8px;font-size:12px;color:var(--text);line-height:1.6;white-space:pre-line}
.recipe-meta{display:flex;gap:16px;margin-top:10px;font-size:12px;color:var(--text2)}
.recipe-meta span{display:flex;align-items:center;gap:4px}

.item-row{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border-radius:var(--radius);margin-bottom:8px;position:relative;overflow:hidden;transition:var(--transition);touch-action:pan-y}
.item-row.swiping{transition:none}
.item-row .item-bg{position:absolute;top:0;bottom:0;width:100%;display:flex;align-items:center;padding:0 20px;font-size:14px;font-weight:600;color:#fff;z-index:0}
.item-bg.left{left:-100%;background:var(--green);justify-content:flex-end}
.item-bg.right{right:-100%;background:var(--red);justify-content:flex-start}
.item-content{display:flex;align-items:center;gap:12px;width:100%;position:relative;z-index:1;background:var(--card);transition:var(--transition)}
.item-emoji{font-size:28px;width:40px;text-align:center;flex-shrink:0}
.item-info{flex:1;min-width:0}
.item-info h4{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-info p{font-size:11px;color:var(--text2);margin-top:2px}
.item-badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;flex-shrink:0}
.item-badge.green{background:rgba(0,184,148,.15);color:var(--green)}
.item-badge.yellow{background:rgba(253,203,110,.15);color:var(--yellow)}
.item-badge.orange{background:rgba(225,112,85,.15);color:var(--orange)}
.item-badge.red{background:rgba(214,48,49,.15);color:var(--red)}
.item-badge.frozen{background:rgba(116,185,255,.15);color:#74b9ff}

.fab{position:fixed;bottom:148px;right:20px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 4px 20px rgba(108,92,231,.4);z-index:99;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.fab:active{transform:scale(.85) rotate(90deg)}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--bg2);border-radius:24px 24px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;padding:24px 20px max(20px,env(safe-area-inset-bottom));animation:slideUp .3s ease}
.modal-handle{width:40px;height:4px;background:var(--bg3);border-radius:4px;margin:0 auto 20px}
.modal h2{font-size:20px;margin-bottom:20px;text-align:center}

.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-input{width:100%;padding:14px 16px;background:var(--bg3);border:2px solid transparent;border-radius:12px;color:var(--text);font-size:15px;outline:none;transition:var(--transition)}
.form-input:focus{border-color:var(--accent)}
.form-input::placeholder{color:var(--text2)}
select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239999b0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
option{background:var(--bg2);color:var(--text)}

.quick-add{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.quick-chip{padding:8px 14px;background:var(--bg3);border:none;color:var(--text);border-radius:20px;font-size:13px;cursor:pointer;transition:var(--transition)}
.quick-chip:active{transform:scale(.9);background:var(--accent)}

.btn{padding:14px 24px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:var(--transition);width:100%}
.btn:active{transform:scale(.96)}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-danger{background:linear-gradient(135deg,var(--red),#e84393);color:#fff}
.btn-secondary{background:var(--bg3);color:var(--text)}
.btn-row{display:flex;gap:10px;margin-top:16px}
.btn-row .btn{flex:1}

.filter-row{display:flex;gap:8px;overflow-x:auto;padding:8px 0;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.filter-chip{padding:8px 16px;background:var(--bg3);border:none;color:var(--text2);border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:var(--transition);flex-shrink:0}
.filter-chip.active{background:var(--accent);color:#fff}

.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.stat-card{background:var(--card);border-radius:var(--radius);padding:16px;text-align:center}
.stat-card .stat-num{font-size:28px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-card .stat-label{font-size:11px;color:var(--text2);margin-top:4px}
.chart-container{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.chart-container h3{font-size:14px;margin-bottom:12px}
canvas{width:100%;height:auto}

.badge-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.badge-item{background:var(--card);border-radius:var(--radius);padding:16px;text-align:center;opacity:.4;transition:var(--transition)}
.badge-item.earned{opacity:1;animation:pulse .5s ease}
.badge-item .badge-icon{font-size:36px;margin-bottom:8px}
.badge-item .badge-name{font-size:11px;font-weight:600}

.config-item{display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--card);border-radius:var(--radius);margin-bottom:8px}
.config-item .config-left{display:flex;align-items:center;gap:12px}
.config-item .config-left .config-icon{font-size:22px}
.config-item .config-left div h4{font-size:14px}
.config-item .config-left div p{font-size:11px;color:var(--text2)}
.toggle{width:48px;height:28px;background:var(--bg3);border-radius:14px;position:relative;cursor:pointer;transition:var(--transition);border:none;flex-shrink:0}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:var(--transition)}
.toggle.on::after{left:23px}

.empty-state{text-align:center;padding:40px 20px}
.empty-state .empty-emoji{font-size:64px;margin-bottom:16px}
.empty-state h3{font-size:18px;margin-bottom:8px}
.empty-state p{font-size:13px;color:var(--text2)}

.waste-input{display:flex;align-items:center;gap:8px;margin:16px 0}
.waste-input span{font-size:20px;font-weight:700;color:var(--green)}

.tip-card{background:linear-gradient(135deg,rgba(0,184,148,.12),rgba(0,184,148,.04));border-radius:var(--radius);padding:18px 16px;margin-bottom:12px;border:1px solid rgba(0,184,148,.15);font-size:15px;display:flex;align-items:center;gap:12px;line-height:1.5}
.tip-card .tip-icon{font-size:28px;flex-shrink:0}

.search-bar{position:relative;margin-bottom:12px}
.search-bar input{width:100%;padding:12px 16px 12px 42px;background:var(--bg3);border:2px solid transparent;border-radius:12px;color:var(--text);font-size:14px;outline:none;transition:var(--transition)}
.search-bar input:focus{border-color:var(--accent)}
.search-bar::before{content:'üîç';position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px}

.photo-btn{width:100%;padding:30px;border:2px dashed var(--bg3);border-radius:12px;background:none;color:var(--text2);font-size:14px;cursor:pointer;text-align:center;transition:var(--transition)}
.photo-btn:active{border-color:var(--accent);color:var(--accent)}
.photo-preview{width:100%;height:120px;object-fit:cover;border-radius:12px;margin-top:8px}

.share-code{font-size:36px;font-weight:900;letter-spacing:12px;text-align:center;padding:20px;background:var(--bg3);border-radius:var(--radius);font-family:monospace;color:var(--accent)}

.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--card);color:var(--text);padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;z-index:300;box-shadow:var(--shadow);transition:var(--transition);display:flex;align-items:center;gap:8px;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}

.freezer-info{background:linear-gradient(135deg,rgba(116,185,255,.12),rgba(116,185,255,.04));border-radius:12px;padding:12px;margin-top:8px;font-size:12px;color:#74b9ff;border:1px solid rgba(116,185,255,.15)}

/* AI Badge */
.ai-badge{display:inline-flex;align-items:center;gap:3px;background:linear-gradient(135deg,rgba(108,92,231,.25),rgba(168,85,247,.15));color:var(--accent2);font-size:10px;font-weight:700;padding:3px 8px;border-radius:10px;letter-spacing:.5px;vertical-align:middle}
.ai-badge::before{content:'‚ú®'}

/* AI Loading Shimmer */
.ai-loading{background:linear-gradient(90deg,var(--bg3) 25%,rgba(108,92,231,.15) 50%,var(--bg3) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--radius);padding:20px;margin-bottom:12px;text-align:center;color:var(--text2);font-size:13px}
.ai-loading .ai-spinner{display:inline-block;animation:sparkle 1s infinite;margin-right:6px}

/* AI NL Input */
.ai-chat-bar{position:fixed;bottom:76px;left:0;right:0;background:var(--bg);padding:10px 16px 12px;z-index:99}
.ai-box-input{position:relative}
.ai-box-input textarea{width:100%;padding:12px 90px 12px 14px;background:var(--bg3);border:2px solid transparent;border-radius:24px;color:var(--text);font-size:15px;outline:none;resize:none;min-height:46px;max-height:120px;font-family:inherit;transition:border-color .3s;line-height:1.4;overflow:hidden}
.ai-box-input textarea:focus{border-color:var(--accent)}
.ai-box-input textarea::placeholder{color:var(--text2)}
.ai-box-actions{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:6px;align-items:center}
.ai-box-photo{width:38px;height:38px;border:none;border-radius:10px;background:var(--bg2);color:var(--text2);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.ai-box-photo:active{transform:scale(.85);color:var(--accent)}
.nl-send-btn{width:38px;height:38px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.nl-send-btn:active{transform:scale(.85)}

/* AI Tip Card */
.ai-tip-card{background:linear-gradient(135deg,rgba(168,85,247,.12),rgba(108,92,231,.06));border-radius:var(--radius);padding:14px;margin-bottom:12px;border:1px solid rgba(168,85,247,.15);font-size:13px;line-height:1.5}
.ai-tip-card .ai-tip-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-weight:700;font-size:14px}

/* AI Photo result */
.ai-photo-result{background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(168,85,247,.08));border:1px solid rgba(108,92,231,.2);border-radius:12px;padding:12px;margin-top:8px;font-size:13px}
.ai-photo-result h4{font-size:13px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.ai-photo-result p{font-size:12px;color:var(--text2);margin:2px 0}
.ai-photo-result .ai-apply-btn{margin-top:8px;padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:var(--transition)}
.ai-photo-result .ai-apply-btn:active{transform:scale(.95)}

/* Meal Planning */
.meal-card{background:linear-gradient(135deg,rgba(253,203,110,.12),rgba(225,112,85,.08));border-radius:var(--radius);padding:16px;margin-bottom:12px;border:1px solid rgba(253,203,110,.2)}
.meal-card h3{font-size:16px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.meal-card p{font-size:13px;color:var(--text2);line-height:1.5}
.meal-btn{padding:10px 16px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:var(--transition);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;width:100%;margin-top:10px}
.meal-btn:active{transform:scale(.96)}
.meal-btn.secondary{background:var(--bg3);color:var(--text)}
.meal-recipe{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid rgba(108,92,231,.15)}
.meal-recipe h4{font-size:15px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.meal-recipe .ing-list{font-size:12px;color:var(--text2);margin:6px 0}
.meal-recipe .ing-list .has{color:var(--green);font-weight:600}
.meal-recipe .ing-list .need{color:var(--orange);font-style:italic}
.meal-recipe .steps{font-size:12px;line-height:1.6;margin-top:8px;white-space:pre-line}
.meal-recipe .recipe-actions{display:flex;gap:8px;margin-top:10px}
.meal-recipe .recipe-actions button{flex:1;padding:8px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:var(--transition)}
.meal-recipe .recipe-actions .use-btn{background:var(--green);color:#fff}
.meal-recipe .recipe-actions .plan-btn{background:var(--bg3);color:var(--text)}

/* Weekly Planner */
.planner-section{margin-bottom:16px}
.planner-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.planner-day{background:var(--card);border-radius:10px;padding:8px 4px;text-align:center;min-height:80px;cursor:pointer;transition:var(--transition);border:2px solid transparent;position:relative}
.planner-day:active{transform:scale(.96)}
.planner-day.today{border-color:var(--accent)}
.planner-day .day-label{font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase}
.planner-day .day-num{font-size:14px;font-weight:800;margin:2px 0}
.planner-day .day-recipe{font-size:9px;color:var(--accent2);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
.planner-day .day-emoji{font-size:18px;margin-top:2px}
.planner-day.has-recipe{background:linear-gradient(135deg,rgba(108,92,231,.1),rgba(168,85,247,.06))}
.planner-ingredients{background:var(--card);border-radius:var(--radius);padding:14px;margin-top:10px}
.planner-ingredients h4{font-size:13px;margin-bottom:8px}
.planner-ingredients .ing-row{display:flex;align-items:center;gap:6px;font-size:12px;padding:3px 0}
.planner-ingredients .ing-row.available{color:var(--green)}
.planner-ingredients .ing-row.missing{color:var(--orange)}

/* Chef Mode */
.chef-card{background:linear-gradient(135deg,rgba(0,184,148,.12),rgba(108,92,231,.08));border-radius:var(--radius);padding:16px;margin-bottom:12px;border:1px solid rgba(0,184,148,.15)}
.chef-card h3{font-size:16px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.chef-stats{display:flex;gap:12px;margin-bottom:10px}
.chef-stat{flex:1;text-align:center;background:var(--bg3);border-radius:10px;padding:10px 6px}
.chef-stat .stat-val{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--green),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.chef-stat .stat-lbl{font-size:10px;color:var(--text2);margin-top:2px}
.chef-badges{display:flex;gap:8px;flex-wrap:wrap}
.chef-badge{display:flex;align-items:center;gap:4px;padding:6px 10px;border-radius:20px;font-size:11px;font-weight:600;background:var(--bg3);opacity:.4}
.chef-badge.earned{opacity:1;background:linear-gradient(135deg,rgba(0,184,148,.2),rgba(108,92,231,.1));border:1px solid rgba(0,184,148,.2)}

/* Daily Suggestion */
.daily-suggestion{background:linear-gradient(135deg,rgba(253,203,110,.15),rgba(225,112,85,.08));border-radius:var(--radius);padding:16px;margin-bottom:12px;border:1px solid rgba(253,203,110,.2);animation:slideUp .4s ease}
.daily-suggestion h3{font-size:15px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.daily-suggestion p{font-size:13px;color:var(--text2);line-height:1.5}
.daily-suggestion .suggestion-action{margin-top:10px;display:flex;gap:8px}
.daily-suggestion .suggestion-action button{padding:8px 14px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer}

/* Planner Modal */
.planner-modal-day{font-size:16px;font-weight:700;text-align:center;margin-bottom:12px}
.planner-recipe-pick{background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:var(--transition)}
.planner-recipe-pick:active{transform:scale(.97);background:var(--accent);color:#fff}

/* Barcode Scanner */
.barcode-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:250;display:none;align-items:center;justify-content:center;flex-direction:column}
.barcode-modal-overlay.active{display:flex}
.barcode-header{color:#fff;font-size:16px;font-weight:700;margin-bottom:12px;text-align:center}
.barcode-header p{font-size:12px;color:rgba(255,255,255,.6);margin-top:4px}
#barcode-reader{width:min(90vw,400px);border-radius:16px;overflow:hidden}
.barcode-close{margin-top:16px;padding:12px 32px;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
.barcode-close:active{transform:scale(.95)}
.ai-box-barcode{width:38px;height:38px;border:none;border-radius:10px;background:var(--bg2);color:var(--text2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.ai-box-barcode:active{transform:scale(.85);color:var(--accent)}

/* Nutrition Info */
.nutrition-section{background:linear-gradient(135deg,rgba(0,184,148,.1),rgba(0,184,148,.04));border:1px solid rgba(0,184,148,.15);border-radius:12px;padding:14px;margin-bottom:16px;display:none}
.nutrition-section.visible{display:block}
.nutrition-section h4{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.nutrition-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.nutrition-item{background:var(--bg3);border-radius:8px;padding:10px;text-align:center}
.nutrition-item .nut-value{font-size:18px;font-weight:800;color:var(--green)}
.nutrition-item .nut-label{font-size:10px;color:var(--text2);margin-top:2px}

/* Shopping List */
.shop-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border-radius:var(--radius);margin-bottom:8px;transition:var(--transition)}
.shop-item.bought{opacity:.5;text-decoration:line-through}
.shop-check{width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);background:none;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;color:transparent;transition:var(--transition)}
.shop-check.checked{background:var(--green);border-color:var(--green);color:#fff}
.shop-info{flex:1;min-width:0}
.shop-info h4{font-size:14px;font-weight:600}
.shop-info p{font-size:11px;color:var(--text2);margin-top:2px}
.shop-suggestion{font-size:11px;color:var(--accent2);margin-top:2px;font-style:italic}
.shop-remove{background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:4px}
.shop-actions{display:flex;gap:8px;margin-bottom:16px}
.shop-actions .btn{flex:1;font-size:13px;padding:10px}
.shop-add-row{display:flex;gap:8px;margin-bottom:16px}
.shop-add-row input{flex:1}
.shop-add-row button{white-space:nowrap}

/* Barcode product card */
.barcode-product-card{background:linear-gradient(135deg,rgba(108,92,231,.12),rgba(0,184,148,.08));border:1px solid rgba(108,92,231,.2);border-radius:12px;padding:16px;margin-bottom:12px}
.barcode-product-card img{width:80px;height:80px;object-fit:contain;border-radius:8px;background:#fff;float:right;margin-left:12px}
.barcode-product-card h3{font-size:15px;margin-bottom:4px}
.barcode-product-card .brand{font-size:12px;color:var(--text2);margin-bottom:8px}
.barcode-product-card .categories{font-size:11px;color:var(--accent2);margin-bottom:8px}

/* === GAMIFICATION === */
.economy-hero{background:linear-gradient(135deg,rgba(0,184,148,.2),rgba(0,184,148,.06));border-radius:var(--radius);padding:20px;margin-bottom:16px;text-align:center;border:1px solid rgba(0,184,148,.2);position:relative;overflow:hidden}
.economy-hero::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(0,184,148,.08) 0%,transparent 60%);animation:pulse 4s infinite}
.economy-hero .eco-amount{font-size:36px;font-weight:900;color:var(--green);position:relative}
.economy-hero .eco-label{font-size:13px;color:var(--text2);margin-top:4px}
.economy-waste{background:linear-gradient(135deg,rgba(214,48,49,.15),rgba(214,48,49,.05));border-radius:var(--radius);padding:14px;margin-bottom:12px;text-align:center;border:1px solid rgba(214,48,49,.15)}
.economy-waste .eco-waste-amount{font-size:24px;font-weight:800;color:var(--red)}
.economy-bar{background:var(--bg3);border-radius:20px;height:24px;overflow:hidden;margin:12px 0;position:relative}
.economy-bar-fill{height:100%;border-radius:20px;background:linear-gradient(90deg,var(--green),#55efc4);transition:width .6s ease}
.economy-bar-text{position:absolute;top:0;left:0;right:0;height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.3)}

.level-card{background:linear-gradient(135deg,rgba(108,92,231,.2),rgba(168,85,247,.1));border-radius:var(--radius);padding:18px;margin-bottom:16px;border:1px solid rgba(108,92,231,.2)}
.level-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.level-icon{font-size:36px}
.level-info{flex:1;margin-left:12px}
.level-info h3{font-size:16px;font-weight:800}
.level-info p{font-size:11px;color:var(--text2)}
.level-xp{text-align:right}
.level-xp .xp-num{font-size:20px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.level-xp .xp-label{font-size:10px;color:var(--text2)}
.xp-bar{background:var(--bg3);border-radius:10px;height:10px;overflow:hidden;margin-top:8px}
.xp-bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .6s ease}

.challenge-card{background:linear-gradient(135deg,rgba(253,203,110,.15),rgba(253,203,110,.05));border-radius:var(--radius);padding:16px;margin-bottom:12px;border:1px solid rgba(253,203,110,.2)}
.challenge-card h3{font-size:15px;font-weight:700;margin-bottom:6px}
.challenge-card p{font-size:12px;color:var(--text2);margin-bottom:10px}
.challenge-progress{background:var(--bg3);border-radius:10px;height:14px;overflow:hidden;position:relative}
.challenge-progress-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--yellow),var(--orange));transition:width .6s ease}
.challenge-progress-text{position:absolute;top:0;left:0;right:0;height:100%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
.challenge-reward{font-size:11px;color:var(--accent);margin-top:8px;font-weight:600}

.ranking-card{background:linear-gradient(135deg,rgba(108,92,231,.12),rgba(168,85,247,.06));border-radius:var(--radius);padding:16px;margin-bottom:12px;border:1px solid rgba(108,92,231,.15)}
.ranking-card h3{font-size:15px;font-weight:700;margin-bottom:12px}
.ranking-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.ranking-row:last-child{border-bottom:none}
.ranking-pos{font-size:18px;font-weight:900;width:28px;text-align:center}
.ranking-name{flex:1;font-size:14px}
.ranking-score{font-size:13px;font-weight:700;color:var(--accent)}

.xp-toast{position:fixed;top:60px;right:20px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700;z-index:300;transform:translateY(-20px);opacity:0;transition:all .3s ease;pointer-events:none}
.xp-toast.show{transform:translateY(0);opacity:1}

.chart-line-container{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.chart-line-container h3{font-size:14px;margin-bottom:12px}
</style>
</head>
<body>
<div id="toast" class="toast"></div>

<header class="header">
  <div><h1>ü•¶ Validade</h1><p style="font-size:11px;color:var(--text2);margin-top:2px">Controle a validade dos seus alimentos com intelig√™ncia artificial</p></div>
  <div class="header-actions">
    <button class="header-btn" onclick="showNotifSummary()" title="Notifica√ß√µes">üîî</button>
    <button class="header-btn" id="themeBtn" onclick="toggleTheme()">üåô</button>
  </div>
</header>

<!-- HOME PAGE -->
<div id="page-home" class="page active">
  <div id="streak-section"></div>
  <div id="nlResult"></div>
  <div id="daily-suggestion-section"></div>
  <div id="alerts-section"></div>
  <div id="meal-planning-section"></div>
  <div id="chef-mode-section"></div>
  <div id="ai-tip-section"></div>
  <div id="tip-section"></div>
  <div id="recipe-suggestion"></div>
  <div id="weekly-planner-section"></div>
  <div id="shopping-card-home"></div>
  <div id="waste-summary"></div>
  <div id="home-empty" class="empty-state" style="display:none">
    <div class="empty-emoji">üõí</div>
    <h3>Sua despensa est√° vazia!</h3>
    <p>Toque no + para adicionar ou digite acima com IA</p>
  </div>
</div>

<!-- ITEMS PAGE -->
<div id="page-items" class="page">
  <div class="search-bar"><input type="text" id="searchInput" placeholder="Buscar itens..." oninput="renderItems()"></div>
  <div class="filter-row" id="filterRow"></div>
  <div id="items-list"></div>
  <div id="items-empty" class="empty-state" style="display:none">
    <div class="empty-emoji">üì¶</div>
    <h3>Nenhum item encontrado</h3>
    <p>Adicione itens para come√ßar a rastrear</p>
  </div>
</div>

<!-- STATS PAGE -->
<div id="page-stats" class="page">
  <div class="stat-grid" id="statGrid"></div>
  <div class="chart-container"><h3>üìä Consumidos vs Desperdi√ßados</h3><canvas id="pieChart" width="300" height="200"></canvas></div>
  <div class="chart-container"><h3>üí∞ Desperd√≠cio Mensal (R$)</h3><canvas id="barChart" width="300" height="200"></canvas></div>
  <div class="section-title">üèÖ Conquistas</div>
  <div class="badge-grid" id="badgeGrid"></div>
</div>

<!-- SHOPPING LIST PAGE -->
<div id="page-compras" class="page">
  <div class="section-title">üõí Lista de Compras</div>
  <div class="shop-add-row">
    <input class="form-input" id="shopManualInput" placeholder="Adicionar item manualmente...">
    <button class="btn btn-primary" onclick="addManualShopItem()" style="padding:12px 16px">+</button>
  </div>
  <div class="shop-actions">
    <button class="btn btn-secondary" onclick="generateSmartList()">‚ú® Gerar Lista</button>
    <button class="btn btn-secondary" onclick="shareShoppingListWA()">üì± Compartilhar</button>
    <button class="btn btn-secondary" onclick="clearBoughtItems()">üóëÔ∏è Limpar</button>
  </div>
  <div id="shop-suggestions-section"></div>
  <div id="shop-list"></div>
  <div id="shop-empty" class="empty-state" style="display:none">
    <div class="empty-emoji">üõí</div>
    <h3>Lista vazia!</h3>
    <p>Toque em "Gerar Lista" ou adicione itens manualmente</p>
  </div>
</div>

<!-- CONFIG PAGE -->
<div id="page-config" class="page">
  <div class="section-title">‚öôÔ∏è Configura√ß√µes</div>
  <div class="config-item">
    <div class="config-left"><span class="config-icon">üåô</span><div><h4>Tema Escuro</h4><p>Apar√™ncia do app</p></div></div>
    <button class="toggle" id="darkToggle" onclick="toggleTheme()"></button>
  </div>
  <div class="config-item">
    <div class="config-left"><span class="config-icon">üîî</span><div><h4>Notifica√ß√µes</h4><p>Ativar sistema de alertas</p></div></div>
    <button class="toggle" id="notifToggle" onclick="toggleNotif()"></button>
  </div>
  <div id="notifSubSettings" style="display:none;padding-left:12px">
    <div class="config-item">
      <div class="config-left"><span class="config-icon">üü°</span><div><h4>3 dias antes</h4><p>Aviso antecipado</p></div></div>
      <button class="toggle" id="notif3daysToggle" onclick="toggleNotifSub('notif3days')"></button>
    </div>
    <div class="config-item">
      <div class="config-left"><span class="config-icon">üü†</span><div><h4>1 dia antes</h4><p>Alerta urgente</p></div></div>
      <button class="toggle" id="notif1dayToggle" onclick="toggleNotifSub('notif1day')"></button>
    </div>
    <div class="config-item">
      <div class="config-left"><span class="config-icon">üî¥</span><div><h4>No dia</h4><p>Vence hoje!</p></div></div>
      <button class="toggle" id="notifTodayToggle" onclick="toggleNotifSub('notifToday')"></button>
    </div>
    <div class="config-item" onclick="toggleMorningSummary(event)">
      <div class="config-left"><span class="config-icon">‚òÄÔ∏è</span><div><h4>Resumo Matinal</h4><p id="morningDesc">Notifica√ß√£o di√°ria √†s 8h</p></div></div>
      <button class="toggle" id="morningToggle"></button>
    </div>
    <div class="config-item" id="morningHourItem" style="display:none">
      <div class="config-left"><span class="config-icon">üïê</span><div><h4>Hor√°rio do Resumo</h4><p>Escolha o hor√°rio</p></div></div>
      <input type="time" id="morningHourInput" value="08:00" style="background:var(--bg2);color:var(--text);border:1px solid var(--bg3);border-radius:8px;padding:6px 10px;font-size:14px" onchange="setMorningHour(this.value)">
    </div>
    <div class="config-item">
      <div class="config-left"><span class="config-icon">üç≥</span><div><h4>Sugest√£o de Receita</h4><p>Dica de uso na notifica√ß√£o</p></div></div>
      <button class="toggle" id="recipeSugToggle" onclick="toggleNotifSub('recipeSuggestion')"></button>
    </div>
  </div>
  <div class="section-title">üè† Minhas Casas</div>
  <div class="card">
    <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Gerencie os locais onde voc√™ armazena alimentos</p>
    <div id="housesList"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input class="form-input" id="newHouseName" placeholder="Ex: Casa da m√£e, Trabalho..." style="flex:1">
      <button class="btn btn-primary" onclick="addHouse()" style="white-space:nowrap">+ Adicionar</button>
    </div>
  </div>
  <div class="section-title">üîó Compartilhar Despensa</div>
  <div class="card">
    <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Compartilhe sua despensa com familiares</p>
    <div class="share-code" id="shareCode">------</div>
    <button class="btn btn-primary" style="margin-top:12px" onclick="generateShareCode()">Gerar C√≥digo</button>
    <div style="border-top:1px solid var(--bg3);margin-top:16px;padding-top:16px">
      <p style="font-size:13px;color:var(--text2);margin-bottom:8px">Recebeu um c√≥digo? Cole aqui para sincronizar:</p>
      <input class="form-input" id="importCodeInput" placeholder="Cole o link aqui" style="width:100%;margin-bottom:8px;font-size:14px;padding:12px">
      <button class="btn btn-primary" onclick="importShareCode()" style="width:100%">Importar</button>
    </div>
  </div>
  <div class="section-title">üíæ Dados</div>
  <div class="config-item" onclick="exportBackup()" style="cursor:pointer">
    <div class="config-left"><span class="config-icon">üì§</span><div><h4>Exportar Backup</h4><p>Salvar dados em JSON</p></div></div>
  </div>
  <div class="config-item" onclick="document.getElementById('importFile').click()" style="cursor:pointer">
    <div class="config-left"><span class="config-icon">üì•</span><div><h4>Importar Backup</h4><p>Restaurar dados de JSON</p></div></div>
  </div>
  <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)">
  <div class="config-item" onclick="exportWhatsApp()" style="cursor:pointer">
    <div class="config-left"><span class="config-icon">üì±</span><div><h4>Compartilhar via WhatsApp</h4><p>Enviar lista como texto</p></div></div>
  </div>
  <div class="config-item" onclick="shareShoppingList()" style="cursor:pointer">
    <div class="config-left"><span class="config-icon">üõí</span><div><h4>Lista de Compras</h4><p>Baseada em itens consumidos</p></div></div>
  </div>
  <div class="section-title" style="margin-top:24px">üë§ Conta</div>
  <div id="accountInfo" class="card" style="text-align:center"></div>
  <div class="section-title" style="margin-top:24px">‚ÑπÔ∏è Sobre</div>
  <div class="card" style="text-align:center">
    <p style="font-size:13px;color:var(--text2)">Validade v2.0 <span class="ai-badge">IA</span></p>
    <p style="font-size:12px;color:var(--text2);margin-top:4px">Rastreador inteligente de validade com Gemini AI</p>
  </div>
</div>

<!-- AI Chat Bar (fixed above bottom nav) -->
<div class="ai-chat-bar">
  <div class="ai-box-input">
    <textarea id="nlInput" placeholder="Descreva o que comprou, tire foto üì∑ ou escaneie o c√≥digo de barras" rows="1"></textarea>
    <div class="ai-box-actions">
      <button class="ai-box-barcode" onclick="startBarcodeScan()" title="Escanear c√≥digo de barras">‚äü</button>
      <button class="ai-box-photo" onclick="homePhoto()">üì∑</button>
      <button class="nl-send-btn" onclick="processNaturalLanguage()">‚û§</button>
    </div>
  </div>
  <input type="file" id="homePhotoInput" accept="image/*" capture="environment" style="display:none" onchange="handleHomePhoto(event)">
</div>

<!-- Barcode Scanner Overlay -->
<div class="barcode-modal-overlay" id="barcodeOverlay">
  <div class="barcode-header">‚äü Escaneie o C√≥digo de Barras<p>Aponte a c√¢mera para o c√≥digo de barras do produto</p></div>
  <div id="barcode-reader"></div>
  <button class="barcode-close" onclick="stopBarcodeScan()">‚úï Fechar</button>
</div>

<!-- FAB -->
<button class="fab" onclick="openAddModal()">+</button>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="nav-item active" data-page="home"><span class="icon">üè†</span>In√≠cio</button>
  <button class="nav-item" data-page="items"><span class="icon">üì¶</span>Itens</button>
  <button class="nav-item" data-page="compras"><span class="icon">üõí</span>Compras</button>
  <button class="nav-item" data-page="stats"><span class="icon">üìä</span>Stats</button>
  <button class="nav-item" data-page="config"><span class="icon">‚öôÔ∏è</span>Config</button>
</nav>

<!-- ADD/EDIT MODAL -->
<div class="modal-overlay" id="addModal">
<div class="modal">
  <div class="modal-handle"></div>
  <h2 id="modalTitle">Adicionar Item</h2>
  <div class="form-group">
    <label>üì∏ Foto / C√≥digo de Barras <span class="ai-badge">IA</span></label>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="photo-btn" id="photoBtn" onclick="capturePhoto()" style="flex:1;padding:16px">üì∑ Tirar Foto</button>
      <button class="photo-btn" onclick="startBarcodeScan()" style="flex:1;padding:16px">‚äü C√≥digo de Barras</button>
    </div>
    <img id="photoPreview" class="photo-preview" style="display:none">
    <div id="aiPhotoResult"></div>
    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(event)">
  </div>
  <div class="section-title">‚ö° Adicionar R√°pido</div>
  <div class="quick-add" id="quickAdd"></div>
  <div class="form-group"><label>Nome</label><input class="form-input" id="fName" placeholder="Ex: Leite Integral"></div>
  <div class="form-group"><label>Categoria</label><select class="form-input" id="fCategory"></select></div>
  <div class="form-group"><label>Casa</label><select class="form-input" id="fHouse"></select></div>
  <div class="form-group"><label>Local</label><select class="form-input" id="fLocation"><option value="geladeira">üßä Geladeira</option><option value="freezer">‚ùÑÔ∏è Freezer</option><option value="despensa">üè† Despensa</option><option value="banheiro">üöø Banheiro</option></select></div>
  <div style="display:flex;gap:10px">
    <div class="form-group" style="flex:1"><label>Quantidade</label><input class="form-input" id="fQty" type="number" value="1" min="1"></div>
    <div class="form-group" style="flex:1"><label>Unidade</label><select class="form-input" id="fUnit"><option>un</option><option>L</option><option>kg</option><option>g</option><option>ml</option><option>pct</option></select></div>
  </div>
  <div class="form-group"><label>Data de Validade</label><input class="form-input" id="fExpiry" type="date"></div>
  <div class="form-group"><label>Pre√ßo Estimado (R$)</label><input class="form-input" id="fPrice" type="number" step="0.01" placeholder="0.00"></div>
  <div class="form-group"><label>üìù Observa√ß√µes</label><textarea class="form-input" id="fNotes" placeholder="Ex: comprei no Zaffari, marca Eleg√™, sem lactose..." rows="2" style="resize:none;height:auto"></textarea></div>
  <div id="nutritionSection" class="nutrition-section">
    <h4>ü•ó Informa√ß√£o Nutricional <span class="ai-badge">OFF</span></h4>
    <div class="nutrition-grid">
      <div class="nutrition-item"><div class="nut-value" id="nutCalories">-</div><div class="nut-label">Calorias (kcal)</div></div>
      <div class="nutrition-item"><div class="nut-value" id="nutProteins">-</div><div class="nut-label">Prote√≠nas (g)</div></div>
      <div class="nutrition-item"><div class="nut-value" id="nutCarbs">-</div><div class="nut-label">Carboidratos (g)</div></div>
      <div class="nutrition-item"><div class="nut-value" id="nutFat">-</div><div class="nut-label">Gorduras (g)</div></div>
    </div>
  </div>
  <div id="freezerInfoBox" class="freezer-info" style="display:none"></div>
  <input type="hidden" id="fId">
  <button class="btn btn-primary" onclick="saveItem()">Salvar</button>
  <button class="btn btn-secondary" style="margin-top:8px" onclick="closeModal('addModal')">Cancelar</button>
</div>
</div>

<!-- WASTE MODAL -->
<div class="modal-overlay" id="wasteModal">
<div class="modal">
  <div class="modal-handle"></div>
  <h2>üóëÔ∏è Registrar Desperd√≠cio</h2>
  <p style="font-size:14px;color:var(--text2);margin-bottom:16px;text-align:center" id="wasteItemName"></p>
  <div class="form-group"><label>Pre√ßo estimado (R$)</label>
    <div class="waste-input"><span>R$</span><input class="form-input" id="wastePrice" type="number" step="0.01" placeholder="0.00"></div>
  </div>
  <input type="hidden" id="wasteItemId">
  <button class="btn btn-danger" onclick="confirmWaste()">Confirmar Desperd√≠cio</button>
  <button class="btn btn-secondary" style="margin-top:8px" onclick="closeModal('wasteModal')">Cancelar</button>
</div>
</div>

<!-- RECIPE MODAL -->
<div class="modal-overlay" id="recipeModal">
<div class="modal">
  <div class="modal-handle"></div>
  <h2>üç≥ Receitas Anti-Desperd√≠cio</h2>
  <div id="aiRecipeSection"></div>
  <div class="section-title">üìñ Receitas Cl√°ssicas</div>
  <div id="recipeList"></div>
  <button class="btn btn-secondary" style="margin-top:12px" onclick="closeModal('recipeModal')">Fechar</button>
</div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal">
<div class="modal">
  <div class="modal-handle"></div>
  <div id="detailContent"></div>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="editFromDetail()">‚úèÔ∏è Editar</button>
    <button class="btn btn-secondary" onclick="consumeFromDetail()">‚úÖ Consumido</button>
  </div>
  <button class="btn btn-danger" style="margin-top:8px" onclick="wasteFromDetail()">üóëÔ∏è Joguei Fora</button>
  <button class="btn btn-secondary" style="margin-top:8px" id="freezeBtn" onclick="freezeFromDetail()">‚ùÑÔ∏è Congelar</button>
  <button class="btn btn-secondary" style="margin-top:8px" id="unfreezeBtn" onclick="unfreezeFromDetail()">üî• Descongelar</button>
  <button class="btn btn-secondary" style="margin-top:8px" onclick="closeModal('detailModal')">Fechar</button>
</div>
</div>

<!-- AUTH MODAL (mandatory ‚Äî no cancel) -->
<div class="modal-overlay" id="authModal">
<div class="modal">
  <div class="modal-handle"></div>
  <div style="text-align:center;margin-bottom:20px">
    <span style="font-size:48px">ü•¶</span>
    <h2 style="margin-top:8px">Bem-vindo ao Validade!</h2>
    <p style="font-size:14px;color:var(--text2);margin-top:8px">Controle seus alimentos com intelig√™ncia artificial. Cadastre-se para come√ßar!</p>
  </div>
  <div id="authRegister">
    <div class="form-group"><label>Nome</label><input class="form-input" id="regName" placeholder="Seu nome completo"></div>
    <div class="form-group"><label>E-mail</label><input class="form-input" id="regEmail" type="email" placeholder="seu@email.com"></div>
    <div class="form-group"><label>Telefone</label><input class="form-input" id="regPhone" type="tel" placeholder="(00) 00000-0000"></div>
    <div class="form-group"><label>Senha</label><input class="form-input" id="regPass" type="password" placeholder="Crie uma senha"></div>
    <button class="btn btn-primary" style="width:100%" onclick="doRegister()">Cadastrar Gr√°tis</button>
    <p style="text-align:center;margin-top:12px;font-size:13px;color:var(--text2)">J√° tem conta? <a href="#" onclick="showLogin()" style="color:var(--accent);font-weight:700">Fazer login</a></p>
  </div>
  <div id="authLogin" style="display:none">
    <div class="form-group"><label>E-mail</label><input class="form-input" id="authEmail" type="email" placeholder="seu@email.com"></div>
    <div class="form-group"><label>Senha</label><input class="form-input" id="authPass" type="password" placeholder="Sua senha"></div>
    <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Entrar</button>
    <p style="text-align:center;margin-top:12px;font-size:13px;color:var(--text2)">N√£o tem conta? <a href="#" onclick="showRegister()" style="color:var(--accent);font-weight:700">Cadastre-se gr√°tis</a></p>
  </div>
</div>
</div>

<!-- PAYWALL MODAL -->
<div class="modal-overlay" id="paywallModal">
<div class="modal">
  <div class="modal-handle"></div>
  <div style="text-align:center;margin-bottom:20px">
    <span style="font-size:48px">‚≠ê</span>
    <h2 style="margin-top:8px">Seja Premium!</h2>
    <p style="font-size:14px;color:var(--text2);margin-top:12px">Voc√™ atingiu o limite de <strong>3 itens gr√°tis</strong>.</p>
    <p style="font-size:14px;color:var(--text2);margin-top:4px">Desbloqueie itens ilimitados e todos os recursos:</p>
  </div>
  <div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:16px">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span>‚úÖ</span><span style="font-size:14px">Itens ilimitados</span></div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span>‚úÖ</span><span style="font-size:14px">Reconhecimento de foto com IA</span></div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span>‚úÖ</span><span style="font-size:14px">Receitas anti-desperd√≠cio</span></div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span>‚úÖ</span><span style="font-size:14px">Compartilhar despensa</span></div>
    <div style="display:flex;align-items:center;gap:8px"><span>‚úÖ</span><span style="font-size:14px">Dicas personalizadas</span></div>
  </div>
  <div style="text-align:center;margin-bottom:16px">
    <span style="font-size:36px;font-weight:900;color:var(--accent)">R$ 4,99</span>
    <span style="font-size:14px;color:var(--text2)">/m√™s</span>
  </div>
  <a href="#" id="premiumLink" class="btn btn-primary" style="width:100%;display:block;text-align:center;text-decoration:none">Assinar Agora</a>
  <button class="btn btn-secondary" style="margin-top:8px;width:100%" onclick="closeModal('paywallModal')">Continuar com limite</button>
</div>
</div>

<script>
// ===== GEMINI API =====
// AI cache to avoid repeated calls
const aiCache={recipes:null,recipesCacheKey:null,tips:null,tipsCacheDate:null};

async function callGemini(parts,maxTokens=1024){
  try{
    const body={contents:[{parts}],generationConfig:{maxOutputTokens:maxTokens,temperature:0.7}};
    // Use server proxy when available (keeps API key server-side)
    const token=getToken();
    if(API_URL!==undefined&&token){
      const resp=await fetch(API_URL+'/api/gemini',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)});
      if(resp.ok){const data=await resp.json();return data.candidates?.[0]?.content?.parts?.[0]?.text||null}
    }
    // Fallback: direct call (GitHub Pages without backend)
    const GEMINI_URL='https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyBnqalI_0KRLZK7ccZ8_vaQSpvhLU_tP5k';
    const resp=await fetch(GEMINI_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!resp.ok)throw new Error(`API ${resp.status}`);
    const data=await resp.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text||null;
  }catch(e){console.error('Gemini error:',e);return null}
}

function extractJSON(text){
  if(!text)return null;
  // Strip markdown code blocks first
  let cleaned=text.replace(/```(?:json)?\s*/gi,'').replace(/```/g,'').trim();
  // Try to find JSON in the response
  const m=cleaned.match(/\[[\s\S]*\]/)||cleaned.match(/\{[\s\S]*\}/);
  if(!m)return null;
  try{return JSON.parse(m[0])}catch(e){
    // Try fixing common issues (trailing commas)
    try{return JSON.parse(m[0].replace(/,\s*([}\]])/g,'$1'))}catch(e2){return null}
  }
}

// HTML escape to prevent XSS
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// ===== DATA =====
const CATEGORIES = [
  {id:'laticinios',name:'Latic√≠nios',emoji:'ü•õ',shelfDays:7},
  {id:'carnes',name:'Carnes',emoji:'ü•©',shelfDays:3},
  {id:'hortifruti',name:'Hortifruti',emoji:'ü•¨',shelfDays:5},
  {id:'padaria',name:'Padaria',emoji:'üçû',shelfDays:3},
  {id:'enlatados',name:'Enlatados',emoji:'ü•´',shelfDays:365},
  {id:'higiene',name:'Higiene',emoji:'üß¥',shelfDays:180},
  {id:'medicamentos',name:'Medicamentos',emoji:'üíä',shelfDays:365},
  {id:'outros',name:'Outros',emoji:'üì¶',shelfDays:30}
];

const PRESETS = [
  {name:'Leite',cat:'laticinios',days:7,emoji:'ü•õ'},
  {name:'Ovos',cat:'laticinios',days:14,emoji:'ü•ö'},
  {name:'Iogurte',cat:'laticinios',days:10,emoji:'ü•õ'},
  {name:'Queijo',cat:'laticinios',days:14,emoji:'üßÄ'},
  {name:'Manteiga',cat:'laticinios',days:30,emoji:'üßà'},
  {name:'Frango',cat:'carnes',days:2,emoji:'üçó'},
  {name:'Carne',cat:'carnes',days:3,emoji:'ü•©'},
  {name:'Peixe',cat:'carnes',days:2,emoji:'üêü'},
  {name:'P√£o',cat:'padaria',days:5,emoji:'üçû'},
  {name:'Banana',cat:'hortifruti',days:5,emoji:'üçå'},
  {name:'Tomate',cat:'hortifruti',days:7,emoji:'üçÖ'},
  {name:'Alface',cat:'hortifruti',days:4,emoji:'ü•¨'},
  {name:'Batata',cat:'hortifruti',days:14,emoji:'ü•î'},
  {name:'Arroz cozido',cat:'outros',days:3,emoji:'üçö'},
  {name:'Presunto',cat:'carnes',days:5,emoji:'ü•ì'},
];

const RECIPES = [
  {name:'Frango ao Molho de Tomate',ingredients:['frango','tomate'],desc:'Refogue o frango, adicione tomates picados, tempere com alho e ervas. Cozinhe por 30min.',time:'40min',diff:'F√°cil'},
  {name:'Carne com Batatas',ingredients:['carne','batata'],desc:'Corte em cubos, doure a carne, adicione batatas e cozinhe com caldo.',time:'50min',diff:'M√©dio'},
  {name:'Omelete de Queijo',ingredients:['ovos','queijo'],desc:'Bata 3 ovos, despeje na frigideira, adicione queijo ralado e dobre.',time:'10min',diff:'F√°cil'},
  {name:'Bolo de Banana',ingredients:['banana'],desc:'Amasse 3 bananas maduras, misture com farinha, a√ß√∫car e ovos. Asse por 40min.',time:'50min',diff:'F√°cil'},
  {name:'Rabanada',ingredients:['p√£o','leite','ovos'],desc:'Molhe o p√£o no leite, passe no ovo batido e frite. Passe em a√ß√∫car com canela.',time:'20min',diff:'F√°cil'},
  {name:'Chocolate Quente',ingredients:['leite'],desc:'Aque√ßa o leite com chocolate em p√≥ e a√ß√∫car. Mexa at√© engrossar.',time:'10min',diff:'F√°cil'},
  {name:'Bolinho de Arroz',ingredients:['arroz'],desc:'Misture arroz cozido com ovo, queijo e temperos. Frite em formato de bolinhos.',time:'25min',diff:'F√°cil'},
  {name:'Salada Caesar',ingredients:['alface','frango','queijo'],desc:'Monte com alface, frango desfiado, queijo parmes√£o e croutons.',time:'15min',diff:'F√°cil'},
  {name:'Pur√™ de Batata',ingredients:['batata','leite','manteiga'],desc:'Cozinhe as batatas, amasse com leite e manteiga. Tempere a gosto.',time:'30min',diff:'F√°cil'},
  {name:'Sandu√≠che Natural',ingredients:['p√£o','presunto','queijo','tomate','alface'],desc:'Monte o sandu√≠che com os ingredientes. Ideal para lanche r√°pido!',time:'5min',diff:'F√°cil'},
  {name:'Banana Caramelizada',ingredients:['banana','manteiga'],desc:'Corte em rodelas, caramelize com a√ß√∫car e manteiga. Sirva com sorvete.',time:'10min',diff:'F√°cil'},
  {name:'Ovo Mexido com Tomate',ingredients:['ovos','tomate'],desc:'Refogue o tomate picado e adicione ovos batidos. Mexa at√© cozinhar.',time:'8min',diff:'F√°cil'},
  {name:'Frango Empanado',ingredients:['frango','ovos'],desc:'Passe o frango no ovo e na farinha de rosca. Frite at√© dourar.',time:'25min',diff:'M√©dio'},
  {name:'Sopa de Legumes',ingredients:['batata','tomate'],desc:'Cozinhe legumes picados em caldo, bata no liquidificador.',time:'35min',diff:'F√°cil'},
  {name:'Torta de Frango',ingredients:['frango','leite','ovos'],desc:'Desfie o frango, prepare massa com leite e ovos, asse por 30min.',time:'45min',diff:'M√©dio'},
  {name:'Crepioca',ingredients:['ovos'],desc:'Misture 1 ovo com 2 colheres de tapioca. Fa√ßa na frigideira como panqueca.',time:'5min',diff:'F√°cil'},
  {name:'Vitamina de Banana',ingredients:['banana','leite'],desc:'Bata banana com leite gelado no liquidificador. Adoce a gosto.',time:'5min',diff:'F√°cil'},
  {name:'Macarr√£o ao Molho',ingredients:['tomate'],desc:'Cozinhe o macarr√£o, fa√ßa molho com tomates frescos, alho e azeite.',time:'25min',diff:'F√°cil'},
  {name:'P√£o com Ovo',ingredients:['p√£o','ovos'],desc:'Frite o ovo e sirva no p√£o. Simples e delicioso!',time:'5min',diff:'F√°cil'},
  {name:'Bruschetta',ingredients:['p√£o','tomate'],desc:'Torre fatias de p√£o, cubra com tomate picado, alho e azeite.',time:'10min',diff:'F√°cil'},
  {name:'Quiche de Queijo',ingredients:['ovos','queijo','leite'],desc:'Misture ovos, leite e queijo. Despeje em forma e asse por 35min.',time:'45min',diff:'M√©dio'},
  {name:'Carne de Panela',ingredients:['carne'],desc:'Doure a carne, adicione √°gua e temperos. Cozinhe em fogo baixo por 2h.',time:'120min',diff:'M√©dio'},
  {name:'Peixe Assado',ingredients:['peixe','tomate','batata'],desc:'Coloque o peixe numa assadeira com batatas e tomates. Asse por 40min.',time:'50min',diff:'M√©dio'},
];

const FREEZER_DURATIONS = {
  'frango':{months:9,tip:'Descongele na geladeira por 24h'},
  'carne':{months:12,tip:'Descongele na geladeira ou em √°gua fria'},
  'peixe':{months:6,tip:'Descongele na geladeira. N√£o recongele.'},
  'p√£o':{months:3,tip:'Descongele em temperatura ambiente ou torre direto'},
  'leite':{months:3,tip:'Descongele na geladeira. Agite bem antes de usar.'},
  'queijo':{months:6,tip:'Melhor para uso culin√°rio ap√≥s descongelado'},
  'banana':{months:3,tip:'Congele sem casca. Ideal para vitaminas.'},
  'default':{months:3,tip:'Descongele na geladeira por seguran√ßa'}
};

const SEASONAL_TIPS = {
  0:['üå°Ô∏è Janeiro: Muito calor! Latic√≠nios e carnes estraguem mais r√°pido fora da geladeira.','üí° Frutas da esta√ß√£o: manga, melancia, abacaxi.'],
  1:['üå°Ô∏è Fevereiro: Cuidado com o calor! Verifique iogurtes e queijos.','üí° Aproveite o tomate ‚Äî est√° na √©poca!'],
  2:['üçÇ Mar√ßo: O outono se aproxima. Frutas como abacate est√£o no ponto.','üí° Boa √©poca para conservas caseiras.'],
  3:['üçÇ Abril: Temperaturas caindo. Sopas s√£o √≥timas para usar legumes!','üí° Batata e cenoura duram mais nessa √©poca.'],
  4:['ü•∂ Maio: Frio chegando. Alimentos na despensa duram um pouco mais.','üí° √âpoca de tangerina e laranja.'],
  5:['‚ùÑÔ∏è Junho: Inverno! Frutas duram mais na despensa.','üí° Aproveite para fazer caldos e sopas.'],
  6:['‚ùÑÔ∏è Julho: Frio intenso. Menos risco de estragar fora da geladeira.','üí° Boa √©poca para organizar o freezer.'],
  7:['üå§Ô∏è Agosto: Ainda frio mas esquentando. Aten√ß√£o aos frios.','üí° √âpoca de morango!'],
  8:['üå∏ Setembro: Primavera! Hortifruti fresco dura menos.','üí° Folhas verdes precisam de mais aten√ß√£o.'],
  9:['üå∏ Outubro: Calor voltando. Reforce a aten√ß√£o com perec√≠veis.','üí° √âpoca de mel√£o e pepino.'],
  10:['‚òÄÔ∏è Novembro: Calor! Redobre o cuidado com latic√≠nios.','üí° Manga e caju est√£o na esta√ß√£o.'],
  11:['üéÑ Dezembro: Festas! Compre com consci√™ncia para n√£o desperdi√ßar.','üí° Planeje as compras de Natal para evitar sobras.']
};

const BADGES = [
  {id:'mestre',name:'Mestre da Despensa',icon:'üëë',desc:'30 dias sem desperd√≠cio',check:s=>s.streak>=30},
  {id:'chef',name:'Chef Criativo',icon:'üë®‚Äçüç≥',desc:'Usou 5 sugest√µes de receita',check:s=>s.recipesUsed>=5},
  {id:'freezer',name:'Freezer Pro',icon:'‚ùÑÔ∏è',desc:'10+ itens congelados gerenciados',check:s=>s.frozenManaged>=10},
  {id:'tracker',name:'Rastreador',icon:'üìä',desc:'50+ itens rastreados',check:s=>s.totalTracked>=50},
  {id:'saver',name:'Econ√¥mico',icon:'üí∞',desc:'Economizou R$100+',check:s=>s.moneySaved>=100},
  {id:'starter',name:'Primeiro Passo',icon:'üåü',desc:'Adicionou primeiro item',check:s=>s.totalTracked>=1},
];

// ===== AUTH & PAYWALL =====
const FREE_LIMIT=3;
const API_URL='';
const PREMIUM_PRICE='R$ 4,99/m√™s';
const PREMIUM_URL='#'; // Link de pagamento

function getUser(){try{return JSON.parse(localStorage.getItem('validade_user'))}catch(e){return null}}
function getToken(){return localStorage.getItem('validade_token')}
function setAuth(token,user){localStorage.setItem('validade_token',token);localStorage.setItem('validade_user',JSON.stringify(user))}
function clearAuth(){localStorage.removeItem('validade_token');localStorage.removeItem('validade_user')}
function isLoggedIn(){return !!getToken()&&!!getUser()}
function isPremium(){const u=getUser();return u&&u.premium===true}
function canAddItem(){
  if(isPremium())return true;
  const active=state.items.filter(i=>i.status==='active'||i.status==='frozen').length;
  return active<FREE_LIMIT;
}
function requireAuth(){
  if(!isLoggedIn()){showAuthScreen();return true}
  if(!canAddItem()){showPaywall();return true}
  return false;
}
function showAuthScreen(){document.getElementById('authModal').classList.add('active');showRegister()}
function showLogin(){document.getElementById('authLogin').style.display='block';document.getElementById('authRegister').style.display='none'}
function showRegister(){document.getElementById('authLogin').style.display='none';document.getElementById('authRegister').style.display='block'}
function showPaywall(){openModal('paywallModal')}

async function doLogin(){
  const email=document.getElementById('authEmail').value.trim();
  const pass=document.getElementById('authPass').value.trim();
  if(!email||!pass){toast('‚ùå Preencha e-mail e senha');return}
  const btn=document.querySelector('#authLogin .btn-primary');
  btn.textContent='Entrando...';btn.disabled=true;
  try{
    const r=await fetch(API_URL+'/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pass})});
    const data=await r.json();
    if(!r.ok){toast('‚ùå '+(data.error||'Erro ao logar'));return}
    setAuth(data.token,data.user);
    closeModal('authModal');
    toast('‚úÖ Bem-vindo, '+data.user.name+'!');
    await syncFromServer();
    renderHome();
  }catch(e){toast('‚ùå Erro de conex√£o')}
  finally{btn.textContent='Entrar';btn.disabled=false}
}

async function doRegister(){
  const name=document.getElementById('regName').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const phone=document.getElementById('regPhone').value.trim();
  const pass=document.getElementById('regPass').value.trim();
  if(!name||!email||!phone||!pass){toast('‚ùå Preencha todos os campos');return}
  if(!email.includes('@')){toast('‚ùå E-mail inv√°lido');return}
  const btn=document.querySelector('#authRegister .btn-primary');
  btn.textContent='Cadastrando...';btn.disabled=true;
  try{
    const r=await fetch(API_URL+'/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,phone,password:pass})});
    const data=await r.json();
    if(!r.ok){toast('‚ùå '+(data.error||'Erro ao cadastrar'));return}
    setAuth(data.token,data.user);
    closeModal('authModal');
    toast('‚úÖ Cadastro realizado! Bem-vindo, '+name+'!');
    renderHome();
  }catch(e){toast('‚ùå Erro de conex√£o')}
  finally{btn.textContent='Cadastrar Gr√°tis';btn.disabled=false}
}

function doLogout(){clearAuth();toast('üëã At√© logo!');showAuthScreen()}

// Sync to server (after adding/removing items)
async function syncToServer(){
  const token=getToken();if(!token)return;
  try{
    await fetch(API_URL+'/api/items',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({data:{items:state.items.map(i=>({...i,photo:null})),stats:state.stats,settings:state.settings}})});
  }catch(e){console.error('Sync error:',e)}
}

// Sync from server (on login)
async function syncFromServer(){
  const token=getToken();if(!token)return;
  try{
    const r=await fetch(API_URL+'/api/items',{headers:{'Authorization':'Bearer '+token}});
    const {data}=await r.json();
    if(data&&data.items&&data.items.length){
      state.items=data.items;
      if(data.stats)state.stats={...state.stats,...data.stats};
      if(data.settings)state.settings={...state.settings,...data.settings};
      save();
    }
  }catch(e){console.error('Sync load error:',e)}
}

// ===== STATE =====
let state = loadState();

function loadState(){
  try{const s=JSON.parse(localStorage.getItem('validade_state'));if(!s)return defaultState();const ds=defaultState();return{...ds,...s,stats:{...ds.stats,...(s.stats||{})},settings:{...ds.settings,...(s.settings||{})}}}catch(e){return defaultState()}
}
function defaultState(){
  return {items:[],stats:{streak:0,lastNoWasteDate:null,recipesUsed:0,frozenManaged:0,totalTracked:0,moneySaved:0,moneyWasted:0,wasteLog:[]},settings:{darkMode:true,notifications:false,morningSummary:false,notif3days:true,notif1day:true,notifToday:true,morningHour:8,recipeSuggestion:false},shareCode:null,houses:[{id:'casa',name:'üè† Minha Casa'}]};
}
function save(){try{localStorage.setItem('validade_state',JSON.stringify(state))}catch(e){console.error('Storage error:',e);toast('‚ö†Ô∏è Armazenamento cheio! Exclua fotos ou itens antigos.')}if(isLoggedIn())syncToServer()}
function uuid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,9)}
function today(){return new Date().toISOString().split('T')[0]}
function daysUntil(d){if(!d||d==='undefined'||d==='null')return 999;const t=new Date(d+'T23:59:59');if(isNaN(t))return 999;return Math.ceil((t-new Date())/(864e5))}
function getCatEmoji(catId){const c=CATEGORIES.find(x=>x.id===catId);return c?c.emoji:'üì¶'}
function getCatName(catId){const c=CATEGORIES.find(x=>x.id===catId);return c?c.name:catId}
function getStatusColor(days){if(days>=999)return'green';if(days<0)return'red';if(days<=2)return'orange';if(days<=7)return'yellow';return'green'}
function getStatusText(days){if(days>=999)return'Sem validade';if(days<0)return`Vencido h√° ${Math.abs(days)}d`;if(days===0)return'Vence hoje!';if(days===1)return'Vence amanh√£';return`${days} dias`}
function locName(l){return{geladeira:'üßä Geladeira',freezer:'‚ùÑÔ∏è Freezer',despensa:'üè† Despensa',banheiro:'üöø Banheiro'}[l]||l}
function getHouses(){if(!state.houses||!state.houses.length)state.houses=[{id:'casa',name:'üè† Minha Casa'}];return state.houses}
function renderHouseSelect(){
  const sel=document.getElementById('fHouse');
  sel.innerHTML=getHouses().map(h=>`<option value="${h.id}">${esc(h.name)}</option>`).join('');
}
function renderHousesList(){
  const el=document.getElementById('housesList');if(!el)return;
  el.innerHTML=getHouses().map((h,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;${i>0?'border-top:1px solid var(--bg3)':''}"><span style="font-size:14px">${esc(h.name)}</span>${state.houses.length>1?`<button style="background:none;border:none;color:var(--red);font-size:18px;cursor:pointer" onclick="removeHouse('${h.id}')">√ó</button>`:''}</div>`).join('');
}
function addHouse(){
  const input=document.getElementById('newHouseName');
  const name=input.value.trim();if(!name){toast('‚ùå Digite o nome da casa');return}
  const id=name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'-');
  if(state.houses.find(h=>h.id===id)){toast('‚ùå Essa casa j√° existe');return}
  state.houses.push({id,name});
  save();input.value='';renderHousesList();renderHouseSelect();
  toast('üè† '+name+' adicionada!');
}
function removeHouse(id){
  if(state.houses.length<=1){toast('‚ùå Precisa ter pelo menos uma casa');return}
  state.houses=state.houses.filter(h=>h.id!==id);
  // Move items from removed house to first house
  state.items.forEach(i=>{if(i.house===id)i.house=state.houses[0].id});
  save();renderHousesList();renderHouseSelect();renderItems();
  toast('üóëÔ∏è Casa removida');
}
function getHouseName(id){const h=getHouses().find(x=>x.id===id);return h?h.name:'üè† Casa'}
function freezerMaxDate(item){
  if(!item.frozenDate)return null;
  // Check if AI already calculated
  if(item.freezerMaxDateCached)return item.freezerMaxDateCached;
  // Fallback to table while AI loads
  const name=(item.name||'').toLowerCase();
  const match=Object.keys(FREEZER_DURATIONS).find(k=>k!=='default'&&name.includes(k));
  const dur=match?FREEZER_DURATIONS[match]:FREEZER_DURATIONS['default'];
  const fd=new Date(item.frozenDate);
  fd.setMonth(fd.getMonth()+dur.months);
  // Ask AI in background for better estimate
  if(!item.freezerAiAsked){
    item.freezerAiAsked=true;
    callGemini([{text:`Produto: "${item.name}". Quantos meses pode ficar congelado no freezer dom√©stico? Responda APENAS em JSON: {"months":numero,"tip":"dica curta"}`}],128).then(r=>{
      const p=extractJSON(r);
      if(p&&p.months){
        const d2=new Date(item.frozenDate);d2.setMonth(d2.getMonth()+p.months);
        item.freezerMaxDateCached=d2.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'});
        if(p.tip)item.freezerTip=p.tip;
        save();renderItems();
      }
    }).catch(()=>{});
  }
  return fd.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'});
}

// ===== TOAST =====
function toast(msg,duration=2500){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),duration);
}

// ===== NAVIGATION =====
document.querySelectorAll('.nav-item').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('page-'+btn.dataset.page).classList.add('active');
    if(btn.dataset.page==='items')renderItems();
    if(btn.dataset.page==='stats')renderStats();
    if(btn.dataset.page==='config')renderConfig();
    if(btn.dataset.page==='home')renderHome();
  });
});

// ===== MODAL HELPERS =====
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
document.querySelectorAll('.modal-overlay').forEach(m=>{
  m.addEventListener('click',e=>{if(e.target===m&&m.id!=='authModal')closeModal(m.id)});
});

// ===== AI FEATURE 1: PHOTO RECOGNITION =====
async function aiRecognizePhoto(base64Data){
  const mimeMatch=base64Data.match(/^data:(image\/\w+);base64,/);
  const mimeType=mimeMatch?mimeMatch[1]:'image/jpeg';
  const rawBase64=base64Data.replace(/^data:image\/\w+;base64,/,'');

  const parts=[
    {text:'Identifique TODOS os produtos aliment√≠cios/dom√©sticos vis√≠veis na foto. Responda APENAS em JSON v√°lido, sem markdown. Se for 1 produto: [{"name":"nome","category":"uma de: laticinios, carnes, hortifruti, padaria, enlatados, higiene, medicamentos, outros","typicalShelfLifeDays":numero,"suggestedLocation":"uma de: geladeira, freezer, despensa, banheiro","estimatedPrice":numero_em_reais}]. Se forem v√°rios, retorne um array com todos.'},
    {inlineData:{mimeType,data:rawBase64}}
  ];

  document.getElementById('aiPhotoResult').innerHTML='<div class="ai-loading"><span class="ai-spinner">‚ú®</span> IA analisando foto...</div>';

  const result=await callGemini(parts,1024);
  let parsed=extractJSON(result);

  // Normalize: always work with array
  if(parsed&&!Array.isArray(parsed)&&parsed.name)parsed=[parsed];
  if(!Array.isArray(parsed)||!parsed.length||!parsed[0].name){
    document.getElementById('aiPhotoResult').innerHTML='<div class="ai-photo-result"><p>‚ùå N√£o foi poss√≠vel identificar. Preencha manualmente.</p></div>';
    return;
  }

  if(parsed.length===1){
    // Single product: auto-apply to form
    const p=parsed[0];
    const cat=CATEGORIES.find(c=>c.id===p.category);
    const priceStr=typeof p.estimatedPrice==='number'?p.estimatedPrice.toFixed(2):null;
    document.getElementById('aiPhotoResult').innerHTML=`
      <div class="ai-photo-result">
        <h4><span class="ai-badge">IA</span> Produto identificado!</h4>
        <p>üì¶ <strong>${esc(p.name)}</strong></p>
        <p>üìÅ ${cat?cat.emoji+' '+cat.name:esc(String(p.category||'outros'))}</p>
        <p>üìÖ Validade t√≠pica: ~${parseInt(p.typicalShelfLifeDays)||7} dias</p>
        <p>üìç Local sugerido: ${locName(p.suggestedLocation||'geladeira')}</p>
        ${priceStr?`<p>üí∞ Pre√ßo estimado: R$ ${priceStr}</p>`:''}
      </div>`;
    window._aiPhotoData=p;
    setTimeout(()=>applyAiPhoto(),300);
  }else{
    // Multiple products: show list with "Add All" button
    window._aiPhotoMulti=parsed;
    let html=`<div class="ai-photo-result"><h4><span class="ai-badge">IA</span> ${parsed.length} produtos encontrados!</h4>`;
    parsed.forEach((p,i)=>{
      const cat=CATEGORIES.find(c=>c.id===p.category);
      const priceStr=typeof p.estimatedPrice==='number'?`R$ ${p.estimatedPrice.toFixed(2)}`:'';
      html+=`<div style="padding:8px 0;${i>0?'border-top:1px solid var(--bg3)':''}">
        <p>üì¶ <strong>${esc(p.name)}</strong> ${priceStr?'‚Äî '+priceStr:''}</p>
        <p style="font-size:12px;color:var(--text2)">${cat?cat.emoji+' '+cat.name:esc(String(p.category||'outros'))} ¬∑ ~${parseInt(p.typicalShelfLifeDays)||7} dias ¬∑ ${locName(p.suggestedLocation||'geladeira')}</p>
      </div>`;
    });
    html+=`<button class="ai-apply-btn" onclick="addAllPhotoItems()" style="width:100%;margin-top:8px">‚úÖ Adicionar Todos (${parsed.length})</button></div>`;
    document.getElementById('aiPhotoResult').innerHTML=html;
  }
}

function addAllPhotoItems(){
  if(requireAuth())return;
  const items=window._aiPhotoMulti;if(!items||!items.length)return;
  const photoSrc=window._photoCompressed||null;
  items.forEach(p=>{
    const dt=new Date();dt.setDate(dt.getDate()+(parseInt(p.typicalShelfLifeDays)||7));
    const validCat=CATEGORIES.find(c=>c.id===(p.category||'').trim().toLowerCase())?p.category.trim().toLowerCase():'outros';
    const validLocs=['geladeira','freezer','despensa','banheiro'];
    const loc=validLocs.includes((p.suggestedLocation||'').toLowerCase())?p.suggestedLocation.toLowerCase():'geladeira';
    state.items.push({
      id:Date.now().toString(36)+Math.random().toString(36).slice(2,7),
      name:p.name,category:validCat,location:loc,
      quantity:1,unit:'un',expiryDate:dt.toISOString().split('T')[0],
      addedDate:today(),photo:photoSrc,price:parseFloat(p.estimatedPrice)||0,
      notes:'',status:'active',frozenDate:null
    });
    state.stats.totalTracked++;
  });
  save();renderHome();renderItems();
  closeModal('addModal');
  toast(`‚úÖ ${items.length} itens adicionados!`);
  window._aiPhotoMulti=null;
}

function applyAiPhoto(){
  const d=window._aiPhotoData;if(!d)return;
  document.getElementById('fName').value=d.name||'';
  if(d.category){
    if(!document.getElementById('fCategory').options.length)renderCategorySelect();
    const catVal=(d.category||'').trim().toLowerCase().replace(/\s+/g,'');
    const validCat=CATEGORIES.find(c=>c.id===catVal);
    document.getElementById('fCategory').value=validCat?validCat.id:'outros';
  }
  if(d.suggestedLocation){
    const loc=(d.suggestedLocation||'').trim().toLowerCase();
    const validLocs=['geladeira','freezer','despensa','banheiro'];
    document.getElementById('fLocation').value=validLocs.includes(loc)?loc:'geladeira';
  }
  if(d.typicalShelfLifeDays){
    const dt=new Date();dt.setDate(dt.getDate()+(parseInt(d.typicalShelfLifeDays)||7));
    document.getElementById('fExpiry').value=dt.toISOString().split('T')[0];
  }
  if(d.estimatedPrice)document.getElementById('fPrice').value=parseFloat(d.estimatedPrice)||'';
  toast('‚úÖ Dados da IA aplicados!');
  // Trigger freezer info check
  document.getElementById('fLocation').dispatchEvent(new Event('change'));
}

// ===== AI FEATURE 2: RECIPE SUGGESTIONS =====
async function aiGetRecipes(expiringItems){
  const names=expiringItems.map(i=>i.name);
  const cacheKey=names.sort().join(',');
  if(aiCache.recipes&&aiCache.recipesCacheKey===cacheKey)return aiCache.recipes;

  const prompt=`Tenho estes ingredientes vencendo nos pr√≥ximos 3 dias: ${names.join(', ')}. Sugira 3 receitas simples brasileiras usando esses ingredientes. Responda APENAS em JSON v√°lido, sem markdown: [{"name":"nome","ingredients":["ing1","ing2"],"prepTime":"Xmin","difficulty":"F√°cil/M√©dio","steps":"passo a passo resumido"}]`;

  const result=await callGemini([{text:prompt}],1024);
  const parsed=extractJSON(result);
  if(Array.isArray(parsed)&&parsed.length){
    aiCache.recipes=parsed;
    aiCache.recipesCacheKey=cacheKey;
    return parsed;
  }
  return null;
}

// ===== AI FEATURE 3: SMART TIPS =====
async function aiGetSmartTips(){
  const t=today();
  // Cache for the day
  if(aiCache.tips&&aiCache.tipsCacheDate===t)return aiCache.tips;

  const items=state.items;
  const active=items.filter(i=>i.status==='active'||i.status==='frozen');
  const wasted=items.filter(i=>i.status==='wasted');
  const consumed=items.filter(i=>i.status==='consumed');

  if(active.length<3&&wasted.length<1)return null; // Not enough data

  // Build consumption pattern summary
  const wastedCats={};
  wasted.forEach(i=>{wastedCats[i.category]=(wastedCats[i.category]||0)+1});
  const totalItems=items.length;
  const wasteRate=totalItems>0?((wasted.length/totalItems)*100).toFixed(0):0;

  const summary=`Minha despensa:
- ${active.length} itens ativos, ${consumed.length} consumidos, ${wasted.length} desperdi√ßados
- Taxa de desperd√≠cio: ${wasteRate}%
- Categorias mais desperdi√ßadas: ${Object.entries(wastedCats).sort((a,b)=>b[1]-a[1]).map(([k,v])=>getCatName(k)+' ('+v+')').join(', ')||'nenhuma'}
- Total gasto com desperd√≠cio: R$ ${state.stats.moneyWasted.toFixed(2)}
- Itens vencendo em 3 dias: ${active.filter(i=>daysUntil(i.expiryDate)<=3&&daysUntil(i.expiryDate)>=0).map(i=>i.name).join(', ')||'nenhum'}`;

  const prompt=`Baseado neste perfil de consumo de alimentos de uma pessoa, d√™ 1-2 dicas curtas e personalizadas em portugu√™s para reduzir desperd√≠cio. Seja espec√≠fico e pr√°tico. M√°ximo 2 frases por dica. Responda APENAS em JSON: [{"tip":"texto da dica","emoji":"emoji relevante"}]\n\n${summary}`;

  const result=await callGemini([{text:prompt}],512);
  const parsed=extractJSON(result);
  if(Array.isArray(parsed)&&parsed.length){
    aiCache.tips=parsed;
    aiCache.tipsCacheDate=t;
    return parsed;
  }
  return null;
}

// ===== AI FEATURE 4: NATURAL LANGUAGE ADD =====
async function processNaturalLanguage(){
  if(requireAuth())return;
  const input=document.getElementById('nlInput').value.trim();
  if(!input){toast('Digite algo!');return}

  const resultDiv=document.getElementById('nlResult');
  resultDiv.innerHTML='<div class="ai-loading"><span class="ai-spinner">‚ú®</span> Entendendo...</div>';

  const todayStr=today();
  const prompt=`O usu√°rio quer adicionar itens √† despensa. Interprete o texto e extraia os dados. Data de hoje: ${todayStr}. Responda APENAS em JSON v√°lido, sem markdown: [{"name":"nome","category":"laticinios/carnes/hortifruti/padaria/enlatados/higiene/medicamentos/outros","quantity":numero,"unit":"un/L/kg/g/ml/pct","expiryDate":"YYYY-MM-DD","location":"geladeira/freezer/despensa/banheiro","price":numero_ou_null}]. Se a data de validade n√£o foi informada, estime baseado no tipo de produto. Texto: "${input}"`;

  const result=await callGemini([{text:prompt}],512);
  const parsed=extractJSON(result);

  if(Array.isArray(parsed)&&parsed.length){
    let html='';
    parsed.forEach((item,i)=>{
      const cat=CATEGORIES.find(c=>c.id===item.category);
      html+=`<div class="ai-photo-result" style="margin-bottom:8px">
        <h4>${cat?cat.emoji:'üì¶'} ${esc(item.name||'Item')} <span class="ai-badge">IA</span></h4>
        <p>üì¶ ${parseInt(item.quantity)||1} ${esc(item.unit||'un')} ¬∑ üìç ${locName(item.location||'geladeira')} ¬∑ üìÖ ${item.expiryDate||'?'}</p>
        <button class="ai-apply-btn" onclick="addFromNL(${i},this)">‚ûï Adicionar</button>
      </div>`;
    });
    html+=`<button class="btn btn-primary" style="margin-top:8px;font-size:13px;padding:10px" onclick="addAllFromNL()">‚úÖ Adicionar Todos (${parsed.length})</button>`;
    resultDiv.innerHTML=html;
    window._nlItems=parsed;
  }else{
    resultDiv.innerHTML='<div class="ai-photo-result"><p>‚ùå N√£o entendi. Tente: "2 litros de leite, vence dia 20"</p></div>';
  }
}

function addFromNL(index,btn){
  const items=window._nlItems;if(!items||!items[index])return;
  const item=items[index];
  const rawLoc=(item.location||'geladeira').trim().toLowerCase();
  const loc=['geladeira','freezer','despensa','banheiro'].includes(rawLoc)?rawLoc:'geladeira';
  const rawCat=(item.category||'outros').trim().toLowerCase().replace(/\s+/g,'');
  const cat=CATEGORIES.find(c=>c.id===rawCat)?rawCat:'outros';
  state.items.push({
    id:uuid(),name:item.name||'Item',category:cat,location:loc,
    quantity:item.quantity||1,unit:item.unit||'un',expiryDate:item.expiryDate||'',
    addedDate:today(),photo:null,price:item.price||0,
    status:loc==='freezer'?'frozen':'active',frozenDate:loc==='freezer'?today():null,notes:'Adicionado via IA'
  });
  state.stats.totalTracked++;
  save();renderHome();renderItems();
  toast('‚úÖ '+item.name+' adicionado!');
  if(btn){btn.textContent='‚úîÔ∏è Adicionado';btn.disabled=true;btn.style.opacity='.5';}
}

function addAllFromNL(){
  if(requireAuth())return;
  const items=window._nlItems;if(!items||!items.length)return;
  window._nlItems=null;
  let count=0;
  items.forEach(item=>{
    const rawLoc=(item.location||'geladeira').trim().toLowerCase();
    const loc=['geladeira','freezer','despensa','banheiro'].includes(rawLoc)?rawLoc:'geladeira';
    const rawCat=(item.category||'outros').trim().toLowerCase().replace(/\s+/g,'');
    const cat=CATEGORIES.find(c=>c.id===rawCat)?rawCat:'outros';
    state.items.push({
      id:uuid(),name:item.name||'Item',category:cat,location:loc,
      quantity:item.quantity||1,unit:item.unit||'un',expiryDate:item.expiryDate||'',
      addedDate:today(),photo:null,price:item.price||0,
      status:loc==='freezer'?'frozen':'active',frozenDate:loc==='freezer'?today():null,notes:'Adicionado via IA'
    });
    state.stats.totalTracked++;count++;
  });
  save();renderHome();renderItems();
  document.getElementById('nlInput').value='';
  document.getElementById('nlResult').innerHTML='';
  toast(`‚úÖ ${count} item(ns) adicionado(s)!`);
}

// NL input: Enter to send
document.getElementById('nlInput').addEventListener('input',function(){this.style.height='46px';this.style.height=Math.min(this.scrollHeight,120)+'px'});
document.getElementById('nlInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();processNaturalLanguage()}
});

// ===== HOME =====
function renderHome(){
  const items = state.items.filter(i=>i.status==='active'||i.status==='frozen');
  const expToday = items.filter(i=>i.status==='active'&&daysUntil(i.expiryDate)===0);
  const exp3 = items.filter(i=>i.status==='active'&&daysUntil(i.expiryDate)>0&&daysUntil(i.expiryDate)<=3);
  const expired = items.filter(i=>i.status==='active'&&daysUntil(i.expiryDate)<0);

  updateStreak();
  document.getElementById('streak-section').innerHTML=`
    <div class="streak-card">
      <div class="streak-fire">üî•</div>
      <div class="streak-num">${state.stats.streak}</div>
      <div class="streak-label">dias sem desperd√≠cio</div>
    </div>`;

  let alerts='';
  if(expired.length) alerts+=`<div class="alert-card red"><span class="alert-icon">‚ö†Ô∏è</span><div class="alert-info"><h3>${expired.length} item(ns) vencido(s)!</h3><p>Verifique e descarte se necess√°rio</p></div><span class="alert-count">${expired.length}</span></div>`;
  if(expToday.length) alerts+=`<div class="alert-card orange"><span class="alert-icon">‚è∞</span><div class="alert-info"><h3>${expToday.length} item(ns) vencem hoje!</h3><p>${expToday.map(i=>esc(i.name)).join(', ')}</p></div><span class="alert-count">${expToday.length}</span></div>`;
  if(exp3.length) alerts+=`<div class="alert-card yellow"><span class="alert-icon">üìÖ</span><div class="alert-info"><h3>${exp3.length} item(ns) nos pr√≥ximos 3 dias</h3><p>${exp3.map(i=>esc(i.name)).join(', ')}</p></div><span class="alert-count">${exp3.length}</span></div>`;
  document.getElementById('alerts-section').innerHTML=alerts;

  // Tips section: 5 tips (seasonal + AI generated, cached)
  renderAllTips();


  // Recipe suggestion (static + AI)
  const expiringSoon=items.filter(i=>i.status==='active'&&daysUntil(i.expiryDate)<=3&&daysUntil(i.expiryDate)>=0);
  const recipe=findRecipe(expiringSoon);
  const rs=document.getElementById('recipe-suggestion');
  if(recipe){
    rs.innerHTML=`<div class="section-title">üç≥ Sugest√£o do Dia</div><div class="recipe-card" onclick="showAllRecipes()"><h3>üç≥ ${recipe.name}</h3><p>${recipe.desc}</p><div class="recipe-meta"><span>‚è±Ô∏è ${recipe.time}</span><span>üìä ${recipe.diff}</span></div></div>`;
  }else rs.innerHTML='';

  // Waste summary
  const thisWeek=state.stats.wasteLog.filter(w=>{const d=new Date(w.date);const now=new Date();return(now-d)<7*864e5});
  const weekWaste=thisWeek.reduce((s,w)=>s+w.price,0);
  document.getElementById('waste-summary').innerHTML=weekWaste>0?`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><div><span style="font-size:12px;color:var(--text2)">Desperd√≠cio esta semana</span><div style="font-size:24px;font-weight:900;color:var(--red)">R$ ${weekWaste.toFixed(2)}</div></div><div style="font-size:11px;color:var(--text2)">‚âà ${Math.floor(weekWaste/15)} refei√ß√µes</div></div></div>`:'';

  document.getElementById('home-empty').style.display=items.length===0?'block':'none';
  if(items.length===0){document.getElementById('streak-section').innerHTML='';document.getElementById('waste-summary').innerHTML=''}
}

async function renderAllTips(){
  const tipSection=document.getElementById('tip-section');
  const aiSection=document.getElementById('ai-tip-section');

  // Start with seasonal tips
  const month=new Date().getMonth();
  const seasonal=SEASONAL_TIPS[month]||[];
  const monthNames=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

  // Check cache (refresh every 6 hours)
  const cacheKey='validade_tips_cache';
  const cached=JSON.parse(localStorage.getItem(cacheKey)||'null');
  const sixHours=6*60*60*1000;
  if(cached&&(Date.now()-cached.ts)<sixHours){
    tipSection.innerHTML=cached.tips.map(t=>`<div class="tip-card"><span class="tip-icon">${t.icon}</span>${esc(t.text)}</div>`).join('');
    aiSection.innerHTML='';
    return;
  }

  // Show seasonal while loading AI tips
  tipSection.innerHTML=seasonal.map(t=>`<div class="tip-card"><span class="tip-icon">üå°Ô∏è</span>${t}</div>`).join('');
  aiSection.innerHTML='';

  // Fetch 5 tips from AI
  const itemNames=state.items.filter(i=>i.status==='active').map(i=>i.name).slice(0,15);
  const context=itemNames.length?`Itens na despensa: ${itemNames.join(', ')}.`:'Despensa vazia.';
  const prompt=`Gere exatamente 5 dicas curtas e variadas sobre conserva√ß√£o de alimentos, aproveitamento e redu√ß√£o de desperd√≠cio. M√™s atual: ${monthNames[month]}. ${context} Responda APENAS em JSON v√°lido: [{"icon":"emoji","text":"dica curta"},...]. Cada dica com no m√°ximo 80 caracteres. Varie entre: sazonalidade, conserva√ß√£o, economia, receitas r√°pidas, organiza√ß√£o.`;

  try{
    const result=await callGemini([{text:prompt}],512);
    const parsed=extractJSON(result);
    if(Array.isArray(parsed)&&parsed.length>=3){
      const tips=parsed.slice(0,5);
      tipSection.innerHTML=tips.map(t=>`<div class="tip-card"><span class="tip-icon">${t.icon||'üí°'}</span>${esc(t.text)}</div>`).join('');
      localStorage.setItem(cacheKey,JSON.stringify({ts:Date.now(),tips}));
    }
  }catch(e){console.error('Tips AI error:',e)}
}

function findRecipe(expiringItems){
  if(!expiringItems.length)return null;
  const names=expiringItems.map(i=>i.name.toLowerCase());
  let best=null,bestScore=0;
  for(const r of RECIPES){
    let score=0;
    for(const ing of r.ingredients){if(names.some(n=>n.includes(ing)))score++}
    if(score>bestScore){bestScore=score;best=r}
  }
  return best;
}

function updateStreak(){
  const t=today();
  const todayWaste=state.stats.wasteLog.some(w=>w.date===t);
  const oldStreak=state.stats.streak;const oldDate=state.stats.lastNoWasteDate;
  if(!state.stats.lastNoWasteDate){state.stats.lastNoWasteDate=t;state.stats.streak=1;}
  else if(!todayWaste){
    const last=new Date(state.stats.lastNoWasteDate);
    const now=new Date(t);
    const diff=Math.floor((now-last)/864e5);
    if(diff<=1){state.stats.streak+=(diff===1?1:0);state.stats.lastNoWasteDate=t;}
    else{state.stats.streak=1;state.stats.lastNoWasteDate=t;}
  }
  if(state.stats.streak!==oldStreak||state.stats.lastNoWasteDate!==oldDate)save();
}

// ===== ITEMS =====
function renderItems(){
  const search=(document.getElementById('searchInput').value||'').toLowerCase();
  const activeFilter=document.querySelector('.filter-chip.active');
  const filterCat=activeFilter?activeFilter.dataset.cat:'all';
  let items=state.items.filter(i=>i.status==='active'||i.status==='frozen');
  if(search)items=items.filter(i=>i.name.toLowerCase().includes(search));
  if(filterCat!=='all')items=items.filter(i=>i.category===filterCat);
  items.sort((a,b)=>new Date(a.expiryDate)-new Date(b.expiryDate));

  const fr=document.getElementById('filterRow');
  fr.innerHTML=`<button class="filter-chip ${filterCat==='all'?'active':''}" data-cat="all" onclick="setFilter('all')">Todos (${state.items.filter(i=>i.status==='active'||i.status==='frozen').length})</button>`;
  CATEGORIES.forEach(c=>{
    const count=state.items.filter(i=>(i.status==='active'||i.status==='frozen')&&i.category===c.id).length;
    if(count)fr.innerHTML+=`<button class="filter-chip ${filterCat===c.id?'active':''}" data-cat="${c.id}" onclick="setFilter('${c.id}')">${c.emoji} ${c.name} (${count})</button>`;
  });

  const list=document.getElementById('items-list');
  document.getElementById('items-empty').style.display=items.length?'none':'block';
  if(!items.length){list.innerHTML='';return}

  list.innerHTML=items.map(item=>{
    let d,color;
    if(item.status==='frozen'){
      const fd=freezerMaxDate(item);
      d=fd?'At√© '+fd:'Congelado';
      color='frozen';
    }else{
      d=getStatusText(daysUntil(item.expiryDate));
      color=getStatusColor(daysUntil(item.expiryDate));
    }
    return `<div class="item-row" data-id="${item.id}" onclick="showDetail(this.dataset.id)">
      <div class="item-bg left">‚úÖ Consumido</div>
      <div class="item-bg right">üóëÔ∏è Deletar</div>
      <div class="item-content">
        <span class="item-emoji">${getCatEmoji(item.category)}</span>
        <div class="item-info"><h4>${esc(item.name)}</h4><p>${item.quantity}${esc(item.unit)} ¬∑ ${locName(item.location)}${item.house&&state.houses&&state.houses.length>1?' ¬∑ '+getHouseName(item.house):''}</p></div>
        <span class="item-badge ${color}">${d}</span>
      </div>
    </div>`;
  }).join('');
  setupSwipe();
}

function setFilter(cat){
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  document.querySelector(`.filter-chip[data-cat="${cat}"]`).classList.add('active');
  renderItems();
}

// ===== SWIPE =====
function setupSwipe(){
  document.querySelectorAll('.item-row').forEach(row=>{
    let startX=0,currentX=0,swiping=false;
    const content=row.querySelector('.item-content');
    row.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;swiping=true;row.classList.add('swiping')},{passive:true});
    row.addEventListener('touchmove',e=>{
      if(!swiping)return;
      currentX=e.touches[0].clientX-startX;
      currentX=Math.max(-120,Math.min(120,currentX));
      content.style.transform=`translateX(${currentX}px)`;
    },{passive:true});
    row.addEventListener('touchend',()=>{
      row.classList.remove('swiping');
      const id=row.dataset.id;
      if(currentX>80){consumeItem(id);content.style.transform='translateX(100%)';}
      else if(currentX<-80){deleteItem(id);content.style.transform='translateX(-100%)';}
      else{content.style.transform='translateX(0)';}
      swiping=false;currentX=0;
    });
  });
}

// ===== ADD/EDIT =====
function openAddModal(presetData){
  if(requireAuth())return;
  document.getElementById('modalTitle').textContent='Adicionar Item';
  document.getElementById('fId').value='';
  document.getElementById('fName').value=presetData?.name||'';
  renderCategorySelect();
  renderHouseSelect();
  document.getElementById('fCategory').value=presetData?.cat||'laticinios';
  document.getElementById('fHouse').value=getHouses()[0]?.id||'casa';
  document.getElementById('fLocation').value='geladeira';
  document.getElementById('fQty').value=1;
  document.getElementById('fUnit').value='un';
  const d=new Date();d.setDate(d.getDate()+(presetData?.days||7));
  document.getElementById('fExpiry').value=d.toISOString().split('T')[0];
  document.getElementById('fPrice').value='';
  document.getElementById('fNotes').value='';
  document.getElementById('photoPreview').style.display='none';
  document.getElementById('photoPreview').src='';
  document.getElementById('aiPhotoResult').innerHTML='';
  document.getElementById('freezerInfoBox').style.display='none';
  window._aiPhotoData=null;
  window._photoCompressed=null;
  window._barcodeNutrition=null;
  document.getElementById('nutritionSection').classList.remove('visible');
  renderQuickAdd();
  openModal('addModal');
}

function renderQuickAdd(){
  document.getElementById('quickAdd').innerHTML=PRESETS.map(p=>`<button class="quick-chip" onclick="quickFill('${p.name}','${p.cat}',${p.days})">${p.emoji} ${p.name}</button>`).join('');
}
function quickFill(name,cat,days){
  document.getElementById('fName').value=name;
  document.getElementById('fCategory').value=cat;
  const d=new Date();d.setDate(d.getDate()+days);
  document.getElementById('fExpiry').value=d.toISOString().split('T')[0];
  toast('‚úÖ '+name+' preenchido!');
}

function renderCategorySelect(){
  document.getElementById('fCategory').innerHTML=CATEGORIES.map(c=>`<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');
}

function saveItem(){
  const name=document.getElementById('fName').value.trim();
  if(!name){toast('‚ùå Digite um nome!');return}
  const id=document.getElementById('fId').value;
  const loc=document.getElementById('fLocation').value;
  const photoSrc=document.getElementById('photoPreview').src;
  const existing=id?state.items.find(i=>i.id===id):null;
  const item={
    id:id||uuid(),name,
    category:document.getElementById('fCategory').value,
    house:document.getElementById('fHouse').value,
    location:loc,
    quantity:parseFloat(document.getElementById('fQty').value)||1,
    unit:document.getElementById('fUnit').value,
    expiryDate:document.getElementById('fExpiry').value,
    addedDate:existing?existing.addedDate:today(),
    photo:window._photoCompressed||(photoSrc&&photoSrc.startsWith('data:')?photoSrc:null)||(existing?existing.photo:null),
    price:parseFloat(document.getElementById('fPrice').value)||0,
    status:existing?(loc==='freezer'&&existing.status==='active'?'frozen':loc!=='freezer'&&existing.status==='frozen'?'active':existing.status):(loc==='freezer'?'frozen':'active'),
    frozenDate:loc==='freezer'?(existing&&existing.frozenDate?existing.frozenDate:today()):null,
    notes:document.getElementById('fNotes').value,
    nutrition:window._barcodeNutrition||(existing?existing.nutrition:null)||null
  };
  if(id){const idx=state.items.findIndex(i=>i.id===id);if(idx>=0)state.items[idx]=item;}
  else{state.items.push(item);state.stats.totalTracked++;}
  save();closeModal('addModal');renderHome();renderItems();
  toast(id?'‚úÖ Item atualizado!':'‚úÖ Item adicionado!');
}

// Photo with AI recognition
function homePhoto(){if(requireAuth())return;document.getElementById('homePhotoInput').value='';document.getElementById('homePhotoInput').click()}
function handleHomePhoto(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const base64=ev.target.result;
    const img=new Image();
    img.onload=async function(){
      const maxW=800;const scale=img.width>maxW?maxW/img.width:1;
      const c=document.createElement('canvas');c.width=img.width*scale;c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const compressed=c.toDataURL('image/jpeg',0.6);
      // Open add modal first
      openAddModal();
      document.getElementById('photoPreview').src=compressed;
      document.getElementById('photoPreview').style.display='block';
      window._photoCompressed=compressed;
      // Run AI recognition with original quality
      aiRecognizePhoto(base64);
    };
    img.src=base64;
  };
  reader.readAsDataURL(file);
}
function capturePhoto(){document.getElementById('photoInput').value='';document.getElementById('photoInput').click()}
function handlePhoto(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const base64=ev.target.result;
    // Compress for storage (max 800px wide, 0.6 quality)
    const img=new Image();
    img.onload=function(){
      const maxW=800;const scale=img.width>maxW?maxW/img.width:1;
      const c=document.createElement('canvas');c.width=img.width*scale;c.height=img.height*scale;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const compressed=c.toDataURL('image/jpeg',0.6);
      document.getElementById('photoPreview').src=compressed;
      document.getElementById('photoPreview').style.display='block';
      // Use original for AI (better recognition), compressed for storage
      window._photoCompressed=compressed;
      aiRecognizePhoto(base64);
    };
    img.src=base64;
  };
  reader.readAsDataURL(file);
}

// Location change ‚Üí freezer info
document.getElementById('fLocation').addEventListener('change',function(){
  const box=document.getElementById('freezerInfoBox');
  if(this.value==='freezer'){
    const name=(document.getElementById('fName').value||'').toLowerCase();
    const info=Object.entries(FREEZER_DURATIONS).find(([k])=>name.includes(k));
    const data=info?info[1]:FREEZER_DURATIONS.default;
    box.innerHTML=`‚ùÑÔ∏è Dura√ß√£o segura no freezer: ~${data.months} meses<br>üí° ${data.tip}`;
    box.style.display='block';
  }else box.style.display='none';
});

// ===== ITEM ACTIONS =====
function consumeItem(id){
  const item=state.items.find(i=>i.id===id);if(!item)return;
  item.status='consumed';
  state.stats.moneySaved+=item.price||0;
  save();renderItems();renderHome();
  toast('‚úÖ '+item.name+' consumido!');
}

function deleteItem(id){
  state.items=state.items.filter(i=>i.id!==id);
  save();renderItems();renderHome();
  toast('üóëÔ∏è Item removido');
}

function wasteItem(id){
  const item=state.items.find(i=>i.id===id);if(!item)return;
  document.getElementById('wasteItemId').value=id;
  document.getElementById('wasteItemName').textContent=item.name;/*safe:textContent*/
  document.getElementById('wastePrice').value=item.price||'';
  openModal('wasteModal');
}

function confirmWaste(){
  const id=document.getElementById('wasteItemId').value;
  const price=parseFloat(document.getElementById('wastePrice').value)||0;
  const item=state.items.find(i=>i.id===id);if(!item)return;
  item.status='wasted';item.price=price;
  state.stats.moneyWasted+=price;
  state.stats.wasteLog.push({date:today(),price,item:item.name,category:item.category});
  state.stats.streak=0;state.stats.lastNoWasteDate=null;
  save();closeModal('wasteModal');closeModal('detailModal');renderItems();renderHome();
  toast('üò¢ '+item.name+' desperdi√ßado ‚Äî R$ '+price.toFixed(2));
}

function freezeItem(id){
  const item=state.items.find(i=>i.id===id);if(!item)return;
  item.status='frozen';item.frozenDate=today();item.location='freezer';
  state.stats.frozenManaged++;
  save();renderItems();renderHome();
  toast('‚ùÑÔ∏è '+item.name+' congelado!');
}

// ===== DETAIL =====
let currentDetailId=null;
function showDetail(id){
  currentDetailId=id;
  const item=state.items.find(i=>i.id===id);if(!item)return;
  const days=daysUntil(item.expiryDate);
  const color=item.status==='frozen'?'frozen':getStatusColor(days);
  const statusText=item.status==='frozen'?'‚ùÑÔ∏è Congelado':getStatusText(days);
  let html=`<div style="text-align:center;margin-bottom:16px"><span style="font-size:48px">${getCatEmoji(item.category)}</span><h2 style="margin-top:8px">${esc(item.name)}</h2><span class="item-badge ${color}" style="display:inline-block;margin-top:8px;font-size:14px;padding:6px 16px">${statusText}</span></div>`;
  html+=`<div class="card"><p>üìÅ ${getCatName(item.category)}</p><p>üìç ${locName(item.location)}</p><p>üì¶ ${item.quantity} ${esc(item.unit)}</p><p>üìÖ Validade: ${item.expiryDate}</p>`;
  if(item.price)html+=`<p>üí∞ R$ ${item.price.toFixed(2)}</p>`;
  if(item.notes)html+=`<p>üìù ${esc(item.notes)}</p>`;
  if(item.frozenDate)html+=`<p>‚ùÑÔ∏è Congelado em: ${item.frozenDate}</p>`;
  html+=`</div>`;
  if(item.nutrition&&(item.nutrition.calories||item.nutrition.proteins)){
    html+=`<div class="nutrition-section visible"><h4>ü•ó Informa√ß√£o Nutricional (por 100g)</h4><div class="nutrition-grid">
      <div class="nutrition-item"><div class="nut-value">${item.nutrition.calories||'-'}</div><div class="nut-label">kcal</div></div>
      <div class="nutrition-item"><div class="nut-value">${item.nutrition.proteins||'-'}g</div><div class="nut-label">Prote√≠nas</div></div>
      <div class="nutrition-item"><div class="nut-value">${item.nutrition.carbs||'-'}g</div><div class="nut-label">Carboidratos</div></div>
      <div class="nutrition-item"><div class="nut-value">${item.nutrition.fat||'-'}g</div><div class="nut-label">Gorduras</div></div>
    </div></div>`;
  }
  if(item.photo&&item.photo!=='null'&&item.photo.startsWith('data:image/'))html+=`<img src="${item.photo}" style="width:100%;border-radius:12px;margin-bottom:12px">`;
  if(item.status==='frozen'){
    const name=item.name.toLowerCase();
    const info=Object.entries(FREEZER_DURATIONS).find(([k])=>name.includes(k));
    const data=info?info[1]:FREEZER_DURATIONS.default;
    if(item.frozenDate){
      const frozenDate=new Date(item.frozenDate);
      const maxDate=new Date(frozenDate);maxDate.setMonth(maxDate.getMonth()+data.months);
      html+=`<div class="freezer-info">‚ùÑÔ∏è Seguro at√©: ${maxDate.toISOString().split('T')[0]}<br>üí° ${data.tip}</div>`;
    }else{
      html+=`<div class="freezer-info">‚ùÑÔ∏è Dura√ß√£o segura: ~${data.months} meses<br>üí° ${data.tip}</div>`;
    }
  }
  document.getElementById('detailContent').innerHTML=html;
  document.getElementById('freezeBtn').style.display=item.status==='active'?'block':'none';
  document.getElementById('unfreezeBtn').style.display=item.status==='frozen'?'block':'none';
  openModal('detailModal');
}
function editFromDetail(){
  closeModal('detailModal');
  const item=state.items.find(i=>i.id===currentDetailId);if(!item)return;
  document.getElementById('modalTitle').textContent='Editar Item';
  document.getElementById('fId').value=item.id;
  document.getElementById('fName').value=item.name;
  renderCategorySelect();
  renderHouseSelect();
  document.getElementById('fCategory').value=item.category;
  document.getElementById('fHouse').value=item.house||getHouses()[0]?.id||'casa';
  document.getElementById('fLocation').value=item.location;
  document.getElementById('fQty').value=item.quantity;
  document.getElementById('fUnit').value=item.unit;
  document.getElementById('fExpiry').value=item.expiryDate;
  document.getElementById('fPrice').value=item.price||'';
  document.getElementById('fNotes').value=item.notes||'';
  document.getElementById('aiPhotoResult').innerHTML='';
  window._photoCompressed=null;
  window._aiPhotoData=null;
  window._barcodeNutrition=item.nutrition||null;
  if(item.nutrition&&(item.nutrition.calories||item.nutrition.proteins)){
    const ns=document.getElementById('nutritionSection');
    ns.classList.add('visible');
    document.getElementById('nutCalories').textContent=item.nutrition.calories||'-';
    document.getElementById('nutProteins').textContent=item.nutrition.proteins||'-';
    document.getElementById('nutCarbs').textContent=item.nutrition.carbs||'-';
    document.getElementById('nutFat').textContent=item.nutrition.fat||'-';
  }else{document.getElementById('nutritionSection').classList.remove('visible')}
  if(item.photo&&item.photo!=='null'){document.getElementById('photoPreview').src=item.photo;document.getElementById('photoPreview').style.display='block';}
  else{document.getElementById('photoPreview').style.display='none';}
  renderQuickAdd();openModal('addModal');
}
function consumeFromDetail(){consumeItem(currentDetailId);closeModal('detailModal')}
function wasteFromDetail(){closeModal('detailModal');wasteItem(currentDetailId)}
function freezeFromDetail(){freezeItem(currentDetailId);closeModal('detailModal')}
async function unfreezeFromDetail(){
  const item=state.items.find(i=>i.id===currentDetailId);if(!item)return;
  const btn=document.getElementById('unfreezeBtn');
  btn.textContent='üîÑ Consultando IA...';btn.disabled=true;

  let days=3;let tip='Descongele na geladeira por seguran√ßa.';
  try{
    const prompt=`Produto: "${item.name}". Foi congelado. Agora ser√° descongelado. Quantos dias dura na geladeira ap√≥s descongelar? Responda APENAS em JSON: {"days":numero,"tip":"dica curta de como descongelar e conservar","bestLocation":"geladeira ou despensa"}`;
    const result=await callGemini([{text:prompt}],256);
    const parsed=extractJSON(result);
    if(parsed&&parsed.days){
      days=parseInt(parsed.days)||3;
      tip=parsed.tip||tip;
    }
  }catch(e){console.error('AI unfreeze error:',e)}

  item.status='active';
  item.location='geladeira';
  const newExpiry=new Date();
  newExpiry.setDate(newExpiry.getDate()+days);
  item.expiryDate=newExpiry.toISOString().split('T')[0];
  item.frozenDate=null;
  item.notes=(item.notes?item.notes+' | ':'')+'Descongelado em '+today();
  save();renderItems();renderHome();closeModal('detailModal');
  toast(`üî• ${item.name} descongelado! Validade: ${days} dias. ${tip}`);
  btn.textContent='üî• Descongelar';btn.disabled=false;
}

// ===== RECIPES (static + AI) =====
async function showAllRecipes(){
  const items=state.items.filter(i=>i.status==='active'&&daysUntil(i.expiryDate)<=5);
  const names=items.map(i=>i.name.toLowerCase());

  // Static recipes
  let scored=RECIPES.map(r=>{let s=0;r.ingredients.forEach(ing=>{if(names.some(n=>n.includes(ing)))s+=2});return{...r,score:s}});
  scored.sort((a,b)=>b.score-a.score);
  document.getElementById('recipeList').innerHTML=scored.map(r=>`<div class="recipe-card" onclick="useRecipe()"><h3>${r.score>0?'‚≠ê':''} üç≥ ${r.name}</h3><p>${r.desc}</p><div class="recipe-meta"><span>‚è±Ô∏è ${r.time}</span><span>üìä ${r.diff}</span><span>üßÇ ${r.ingredients.join(', ')}</span></div></div>`).join('');

  // AI recipes section
  const aiSection=document.getElementById('aiRecipeSection');
  const expiringItems=state.items.filter(i=>i.status==='active'&&daysUntil(i.expiryDate)<=3&&daysUntil(i.expiryDate)>=0);

  if(expiringItems.length>0){
    aiSection.innerHTML=`<div class="section-title">‚ú® Receitas da IA <span class="ai-badge">IA</span></div><div class="ai-loading"><span class="ai-spinner">‚ú®</span> Gerando receitas personalizadas...</div>`;
    openModal('recipeModal');

    const aiRecipes=await aiGetRecipes(expiringItems);
    if(aiRecipes&&aiRecipes.length){
      aiSection.innerHTML=`<div class="section-title">‚ú® Receitas da IA <span class="ai-badge">IA</span></div>`+
        aiRecipes.map(r=>`<div class="recipe-card" onclick="useRecipe()"><h3>‚ú® ${esc(r.name)} <span class="ai-badge">IA</span></h3><p>${esc(r.steps||'')}</p><div class="recipe-meta"><span>‚è±Ô∏è ${esc(r.prepTime||'?')}</span><span>üìä ${esc(r.difficulty||'?')}</span><span>üßÇ ${(r.ingredients||[]).map(esc).join(', ')}</span></div></div>`).join('');
    }else{
      aiSection.innerHTML=`<div class="section-title">‚ú® Receitas da IA <span class="ai-badge">IA</span></div><div class="ai-photo-result"><p>N√£o foi poss√≠vel gerar receitas. Veja as cl√°ssicas abaixo!</p></div>`;
    }
  }else{
    aiSection.innerHTML='';
    openModal('recipeModal');
  }
}
function useRecipe(){state.stats.recipesUsed++;save();toast('üë®‚Äçüç≥ Receita selecionada! Bom apetite!')}

// ===== STATS =====
function renderStats(){
  const consumed=state.items.filter(i=>i.status==='consumed').length;
  const wasted=state.items.filter(i=>i.status==='wasted').length;
  const active=state.items.filter(i=>i.status==='active'||i.status==='frozen').length;
  document.getElementById('statGrid').innerHTML=`
    <div class="stat-card"><div class="stat-num">${state.stats.totalTracked}</div><div class="stat-label">Itens Rastreados</div></div>
    <div class="stat-card"><div class="stat-num">${active}</div><div class="stat-label">Itens Ativos</div></div>
    <div class="stat-card"><div class="stat-num" style="-webkit-text-fill-color:var(--green)">R$ ${state.stats.moneySaved.toFixed(0)}</div><div class="stat-label">Economizado</div></div>
    <div class="stat-card"><div class="stat-num" style="-webkit-text-fill-color:var(--red)">R$ ${state.stats.moneyWasted.toFixed(0)}</div><div class="stat-label">Desperdi√ßado</div></div>`;
  drawPie(consumed,wasted);
  drawBarChart();
  renderBadges();
}

function drawPie(consumed,wasted){
  const canvas=document.getElementById('pieChart');const ctx=canvas.getContext('2d');
  canvas.width=300;canvas.height=200;ctx.clearRect(0,0,300,200);
  const total=consumed+wasted;
  if(!total){ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text2');ctx.font='14px sans-serif';ctx.textAlign='center';ctx.fillText('Sem dados ainda',150,105);return}
  const cx=100,cy=100,r=70;const consumedAngle=(consumed/total)*Math.PI*2;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,0,consumedAngle);ctx.fillStyle='#00b894';ctx.fill();
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,consumedAngle,Math.PI*2);ctx.fillStyle='#d63031';ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,40,0,Math.PI*2);ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--card').trim();ctx.fill();
  ctx.fillStyle='#00b894';ctx.fillRect(210,60,14,14);ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text').trim();ctx.font='12px sans-serif';ctx.textAlign='left';ctx.fillText(`Consumidos (${consumed})`,230,72);
  ctx.fillStyle='#d63031';ctx.fillRect(210,90,14,14);ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text').trim();ctx.fillText(`Desperdi√ßados (${wasted})`,230,102);
}

function drawBarChart(){
  const canvas=document.getElementById('barChart');const ctx=canvas.getContext('2d');
  canvas.width=300;canvas.height=200;ctx.clearRect(0,0,300,200);
  const months={};
  state.stats.wasteLog.forEach(w=>{const m=w.date.slice(0,7);months[m]=(months[m]||0)+w.price});
  const keys=Object.keys(months).sort().slice(-6);
  if(!keys.length){ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text2');ctx.font='14px sans-serif';ctx.textAlign='center';ctx.fillText('Sem dados de desperd√≠cio',150,105);return}
  const maxVal=Math.max(...keys.map(k=>months[k]),1);
  const barW=36,gap=(300-keys.length*barW)/(keys.length+1);
  keys.forEach((k,i)=>{
    const h=(months[k]/maxVal)*140;const x=gap+(barW+gap)*i;const y=170-h;
    const grad=ctx.createLinearGradient(x,y,x,170);
    grad.addColorStop(0,'#d63031');grad.addColorStop(1,'#e84393');
    ctx.fillStyle=grad;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(x,y,barW,h,4);else{ctx.rect(x,y,barW,h);}ctx.fill();
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text2').trim();ctx.font='10px sans-serif';ctx.textAlign='center';ctx.fillText(k.slice(5),x+barW/2,185);
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text').trim();ctx.font='10px sans-serif';ctx.fillText('R$'+months[k].toFixed(0),x+barW/2,y-4);
  });
}

function renderBadges(){
  const s=state.stats;
  document.getElementById('badgeGrid').innerHTML=BADGES.map(b=>`<div class="badge-item ${b.check(s)?'earned':''}"><div class="badge-icon">${b.icon}</div><div class="badge-name">${b.name}</div></div>`).join('');
}

// ===== CONFIG =====
function renderConfig(){
  document.getElementById('darkToggle').classList.toggle('on',state.settings.darkMode);
  document.getElementById('notifToggle').classList.toggle('on',state.settings.notifications);
  document.getElementById('morningToggle').classList.toggle('on',state.settings.morningSummary);
  // Sub-settings visibility
  const sub=document.getElementById('notifSubSettings');
  if(sub)sub.style.display=state.settings.notifications?'block':'none';
  const n3=document.getElementById('notif3daysToggle');if(n3)n3.classList.toggle('on',state.settings.notif3days!==false);
  const n1=document.getElementById('notif1dayToggle');if(n1)n1.classList.toggle('on',state.settings.notif1day!==false);
  const nt=document.getElementById('notifTodayToggle');if(nt)nt.classList.toggle('on',state.settings.notifToday!==false);
  const rs=document.getElementById('recipeSugToggle');if(rs)rs.classList.toggle('on',!!state.settings.recipeSuggestion);
  const mhi=document.getElementById('morningHourItem');if(mhi)mhi.style.display=state.settings.morningSummary?'flex':'none';
  const mhInput=document.getElementById('morningHourInput');if(mhInput)mhInput.value=String(state.settings.morningHour||8).padStart(2,'0')+':00';
  const md=document.getElementById('morningDesc');if(md)md.textContent='Notifica√ß√£o di√°ria √†s '+(state.settings.morningHour||8)+'h';
  if(state.shareCode)document.getElementById('shareCode').textContent=state.shareCode;
  renderHousesList();
  // Account info
  const user=getUser();
  const ai=document.getElementById('accountInfo');
  if(user){
    const plan=user.premium?'‚≠ê Premium':'Gratuito (at√© 3 itens)';
    ai.innerHTML=`<p style="font-size:15px;font-weight:700">${esc(user.name)}</p><p style="font-size:13px;color:var(--text2);margin-top:4px">${esc(user.email)}</p><p style="font-size:13px;color:var(--text2);margin-top:2px">Plano: ${plan}</p>${!user.premium?'<button class="btn btn-primary" style="margin-top:12px;width:100%" onclick="showPaywall()">‚≠ê Seja Premium ‚Äî '+PREMIUM_PRICE+'</button>':''}<button class="btn btn-secondary" style="margin-top:8px;width:100%" onclick="doLogout()">Sair da conta</button>`;
  }else{ai.innerHTML='<p style="color:var(--text2)">N√£o logado</p>'}
}

function toggleTheme(){
  state.settings.darkMode=!state.settings.darkMode;
  document.body.classList.toggle('light',!state.settings.darkMode);
  document.getElementById('themeBtn').textContent=state.settings.darkMode?'üåô':'‚òÄÔ∏è';
  save();renderConfig();
}

function toggleNotif(){
  if(!state.settings.notifications&&'Notification' in window){
    Notification.requestPermission().then(p=>{
      state.settings.notifications=p==='granted';save();renderConfig();
      if(p==='granted'){toast('üîî Notifica√ß√µes ativadas!');startNotificationChecker();}
    });
  }else{state.settings.notifications=!state.settings.notifications;save();renderConfig();
    if(state.settings.notifications)startNotificationChecker();
  }
}

function toggleNotifSub(key){
  state.settings[key]=!state.settings[key];save();renderConfig();
}

function toggleMorningSummary(e){
  if(e&&e.target.tagName==='INPUT')return;
  state.settings.morningSummary=!state.settings.morningSummary;save();renderConfig();
  toast(state.settings.morningSummary?'‚òÄÔ∏è Resumo matinal ativado':'Resumo matinal desativado');
}

function setMorningHour(val){
  state.settings.morningHour=parseInt(val.split(':')[0])||8;save();renderConfig();
  toast('üïê Resumo √†s '+state.settings.morningHour+'h');
}

// Recipe suggestions map
const RECIPE_HINTS={tomate:'Que tal fazer molho?',banana:'Que tal um bolo de banana?',leite:'Que tal fazer um pudim?',ovo:'Que tal uma omelete?',ovos:'Que tal uma omelete?',queijo:'Que tal uma torrada com queijo?',frango:'Que tal fazer um strogonoff?',carne:'Que tal um ensopado?',iogurte:'Que tal um smoothie?',ma√ß√£:'Que tal uma torta de ma√ß√£?',batata:'Que tal uma sopa?',cenoura:'Que tal um bolo de cenoura?',abacate:'Que tal um guacamole?',lim√£o:'Que tal uma limonada?',p√£o:'Que tal fazer torradas?',arroz:'Que tal arroz frito?',feij√£o:'Que tal uma feijoada?'};

function getRecipeHint(name){
  if(!state.settings.recipeSuggestion)return '';
  const n=name.toLowerCase();
  for(const[k,v]of Object.entries(RECIPE_HINTS)){if(n.includes(k))return ' '+v}
  return ' Que tal usar hoje?';
}

// Smart notification checker
let notifInterval=null;
function startNotificationChecker(){
  if(notifInterval)clearInterval(notifInterval);
  if(!state.settings.notifications)return;
  checkAndNotify();
  notifInterval=setInterval(checkAndNotify,3600000); // every hour
}

function checkAndNotify(){
  if(!state.settings.notifications||!('Notification' in window)||Notification.permission!=='granted')return;
  const now=new Date();
  const today=now.toISOString().split('T')[0];
  const lastNotif=localStorage.getItem('validade_lastNotif')||'';
  const lastMorning=localStorage.getItem('validade_lastMorning')||'';
  const activeItems=state.items.filter(i=>i.status==='active'&&i.expiryDate);

  // Morning summary
  const mHour=state.settings.morningHour||8;
  if(state.settings.morningSummary&&now.getHours()>=mHour&&lastMorning!==today){
    const weekFromNow=new Date(now);weekFromNow.setDate(weekFromNow.getDate()+7);
    const weekStr=weekFromNow.toISOString().split('T')[0];
    const thisWeek=activeItems.filter(i=>i.expiryDate>=today&&i.expiryDate<=weekStr);
    if(thisWeek.length>0){
      showLocalNotif('‚òÄÔ∏è Bom dia!','Voc√™ tem '+thisWeek.length+' ite'+(thisWeek.length===1?'m':'ns')+' vencendo esta semana','morning');
    }
    localStorage.setItem('validade_lastMorning',today);
  }

  // Don't repeat daily alerts
  if(lastNotif===today)return;

  const in3=new Date(now);in3.setDate(in3.getDate()+3);
  const in3str=in3.toISOString().split('T')[0];
  const in1=new Date(now);in1.setDate(in1.getDate()+1);
  const in1str=in1.toISOString().split('T')[0];

  // Today
  if(state.settings.notifToday!==false){
    const todayItems=activeItems.filter(i=>i.expiryDate===today);
    todayItems.forEach(i=>showLocalNotif('üî¥ Vence HOJE!',i.name+' vence HOJE! N√£o desperdice!'+getRecipeHint(i.name),'today-'+i.id));
  }
  // 1 day
  if(state.settings.notif1day!==false){
    const tmrwItems=activeItems.filter(i=>i.expiryDate===in1str);
    tmrwItems.forEach(i=>showLocalNotif('üü† Vence amanh√£!',i.name+' vence amanh√£! Use antes que estrague'+getRecipeHint(i.name),'1day-'+i.id));
  }
  // 3 days
  if(state.settings.notif3days!==false){
    const soon=activeItems.filter(i=>i.expiryDate===in3str);
    soon.forEach(i=>showLocalNotif('üü° Vence em 3 dias','Seu '+i.name+' vence em 3 dias.'+getRecipeHint(i.name),'3day-'+i.id));
  }
  localStorage.setItem('validade_lastNotif',today);
}

function showLocalNotif(title,body,tag){
  try{
    if(navigator.serviceWorker&&navigator.serviceWorker.controller){
      navigator.serviceWorker.ready.then(reg=>{
        reg.showNotification(title,{body,icon:'ü•¶',badge:'‚ö†Ô∏è',tag:'validade-'+tag,data:{url:'/'},vibrate:[200,100,200]});
      });
    }else{
      new Notification(title,{body,tag:'validade-'+tag});
    }
  }catch(e){console.warn('Notification error:',e)}
}

async function generateShareCode(){
  const code=Math.random().toString(36).slice(2,8).toUpperCase();
  const data={items:state.items.map(i=>({...i,photo:null})),stats:state.stats};
  const btn=document.querySelector('[onclick="generateShareCode()"]');
  btn.textContent='Gerando...';btn.disabled=true;
  try{
    const resp=await fetch('https://ntfy.sh/validade-share-'+code,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!resp.ok)throw new Error('Falha ao salvar');
    state.shareCode=code;save();
    document.getElementById('shareCode').textContent=code;
    if(navigator.clipboard){
      await navigator.clipboard.writeText(code);
      toast('üîó C√≥digo copiado! Envie para quem quiser importar. V√°lido por 12h.');
    }else{
      toast('üîó C√≥digo: '+code+' ‚Äî V√°lido por 12h.');
    }
  }catch(e){toast('‚ùå Erro ao gerar c√≥digo. Tente novamente.')}
  btn.textContent='Gerar C√≥digo';btn.disabled=false;
}
async function importShareCode(){
  const code=document.getElementById('importCodeInput').value.trim().toUpperCase();
  if(!code){toast('‚ùå Digite o c√≥digo');return}
  const btn=document.querySelector('[onclick="importShareCode()"]');
  btn.textContent='Importando...';btn.disabled=true;
  try{
    const resp=await fetch('https://ntfy.sh/validade-share-'+code+'/json?poll=1&since=12h');
    if(!resp.ok)throw new Error('C√≥digo n√£o encontrado');
    const text=await resp.text();
    const lines=text.trim().split('\n');
    // Get the latest message
    const last=JSON.parse(lines[lines.length-1]);
    const data=JSON.parse(last.message);
    if(!data.items||!Array.isArray(data.items)){throw new Error('Dados inv√°lidos')}
    const existingNames=new Set(state.items.map(i=>i.name.toLowerCase()));
    let added=0;
    data.items.forEach(item=>{
      if(!existingNames.has(item.name.toLowerCase())){
        item.id=Date.now().toString(36)+Math.random().toString(36).slice(2,7);
        state.items.push(item);
        existingNames.add(item.name.toLowerCase());
        added++;
      }
    });
    save();renderHome();renderItems();
    toast(`üì• ${added} itens importados de ${data.items.length}!`);
    document.getElementById('importCodeInput').value='';
  }catch(e){toast('‚ùå C√≥digo n√£o encontrado ou expirado. Pe√ßa um novo c√≥digo.')}
  btn.textContent='Importar';btn.disabled=false;
}

function showNotifSummary(){
  const items=state.items.filter(i=>i.status==='active');
  const expiring=items.filter(i=>daysUntil(i.expiryDate)<=7&&daysUntil(i.expiryDate)>=0);
  const expired=items.filter(i=>daysUntil(i.expiryDate)<0);
  let msg='üìã Resumo:\n';
  if(expired.length)msg+=`‚ö†Ô∏è ${expired.length} vencido(s)\n`;
  if(expiring.length)msg+=`‚è∞ ${expiring.length} vencem em at√© 7 dias\n`;
  if(!expired.length&&!expiring.length)msg+='‚úÖ Tudo em ordem!';
  toast(msg,3000);
}

// ===== EXPORT/IMPORT =====
function exportBackup(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='validade_backup.json';a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
  toast('üì§ Backup exportado!');
}

function importBackup(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{const imported=JSON.parse(ev.target.result);const ds=defaultState();state={...ds,...imported,stats:{...ds.stats,...(imported.stats||{})},settings:{...ds.settings,...(imported.settings||{})}};save();document.body.classList.toggle('light',!state.settings.darkMode);document.getElementById('themeBtn').textContent=state.settings.darkMode?'üåô':'‚òÄÔ∏è';renderHome();toast('üì• Backup restaurado!')}
    catch(err){toast('‚ùå Arquivo inv√°lido!')}
  };
  reader.readAsText(file);
  e.target.value='';
}

function exportWhatsApp(){
  const items=state.items.filter(i=>i.status==='active'||i.status==='frozen');
  let text='ü•¶ *Minha Despensa - Validade*\n\n';
  items.forEach(i=>{
    const d=daysUntil(i.expiryDate);
    const status=d>=999?'‚ö™ S/V':d<0?'üî¥ VENCIDO':d<=2?'üü† '+d+'d':d<=7?'üü° '+d+'d':'üü¢ '+d+'d';
    text+=`${getCatEmoji(i.category)} ${i.name} ‚Äî ${status}\n`;
  });
  text+=`\nüìä Total: ${items.length} itens`;
  window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank');
}

function shareShoppingList(){
  const consumed=state.items.filter(i=>i.status==='consumed');
  const names=[...new Set(consumed.map(i=>i.name))];
  if(!names.length){toast('Nenhum item consumido para gerar lista');return}
  let text='üõí *Lista de Compras*\n\n';
  names.forEach(n=>text+=`‚òê ${n}\n`);
  window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank');
}

// ===== BARCODE SCANNER =====
let html5QrCode=null;
let barcodeScanning=false;

function startBarcodeScan(){
  if(requireAuth())return;
  const overlay=document.getElementById('barcodeOverlay');
  overlay.classList.add('active');
  barcodeScanning=true;

  html5QrCode=new Html5Qrcode('barcode-reader');
  html5QrCode.start(
    {facingMode:'environment'},
    {fps:10,qrbox:{width:280,height:150},formatsToSupport:[
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.QR_CODE
    ]},
    onBarcodeDetected,
    ()=>{}
  ).catch(err=>{
    console.error('Camera error:',err);
    toast('‚ùå N√£o foi poss√≠vel acessar a c√¢mera');
    stopBarcodeScan();
  });
}

function stopBarcodeScan(){
  const overlay=document.getElementById('barcodeOverlay');
  overlay.classList.remove('active');
  barcodeScanning=false;
  if(html5QrCode){
    html5QrCode.stop().then(()=>{html5QrCode.clear()}).catch(()=>{});
    html5QrCode=null;
  }
}

async function onBarcodeDetected(decodedText){
  if(!barcodeScanning)return;
  barcodeScanning=false; // prevent multiple triggers
  stopBarcodeScan();
  toast('üîç C√≥digo detectado: '+decodedText);
  await lookupBarcode(decodedText);
}

async function lookupBarcode(barcode){
  // Show loading in nlResult
  const resultDiv=document.getElementById('nlResult');
  resultDiv.innerHTML='<div class="ai-loading"><span class="ai-spinner">‚äü</span> Buscando produto...</div>';

  try{
    const resp=await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
    const data=await resp.json();

    if(data.status!==1||!data.product){
      resultDiv.innerHTML='';
      toast('üì∑ Produto n√£o encontrado no banco. Tire uma foto para a IA identificar!',3000);
      openAddModal();
      setTimeout(()=>capturePhoto(),600);
      return;
    }

    const p=data.product;
    const name=p.product_name||p.product_name_pt||p.product_name_en||'Produto';
    const brand=p.brands||'';
    const categories=p.categories||'';
    const imageUrl=p.image_front_small_url||p.image_url||'';
    const nut=p.nutriments||{};

    const nutrition={
      calories:Math.round(nut['energy-kcal_100g']||nut['energy-kcal']||0),
      proteins:Math.round((nut.proteins_100g||nut.proteins||0)*10)/10,
      carbs:Math.round((nut.carbohydrates_100g||nut.carbohydrates||0)*10)/10,
      fat:Math.round((nut.fat_100g||nut.fat||0)*10)/10,
      fiber:Math.round((nut.fiber_100g||nut.fiber||0)*10)/10,
      sodium:Math.round((nut.sodium_100g||nut.sodium||0)*1000)/10
    };

    // Show product card
    let html=`<div class="barcode-product-card">`;
    if(imageUrl)html+=`<img src="${esc(imageUrl)}" alt="${esc(name)}" onerror="this.style.display='none'">`;
    html+=`<h3>‚äü ${esc(name)}</h3>`;
    if(brand)html+=`<div class="brand">${esc(brand)}</div>`;
    if(categories)html+=`<div class="categories">${esc(categories.split(',').slice(0,3).join(', '))}</div>`;
    if(nutrition.calories||nutrition.proteins||nutrition.carbs||nutrition.fat){
      html+=`<div class="nutrition-grid" style="margin-top:8px">
        <div class="nutrition-item"><div class="nut-value">${nutrition.calories}</div><div class="nut-label">kcal</div></div>
        <div class="nutrition-item"><div class="nut-value">${nutrition.proteins}g</div><div class="nut-label">Prote√≠nas</div></div>
        <div class="nutrition-item"><div class="nut-value">${nutrition.carbs}g</div><div class="nut-label">Carboidratos</div></div>
        <div class="nutrition-item"><div class="nut-value">${nutrition.fat}g</div><div class="nut-label">Gorduras</div></div>
      </div>`;
    }
    html+=`<button class="ai-apply-btn" style="width:100%;margin-top:10px" onclick="applyBarcodeProduct()">‚úÖ Adicionar este produto</button></div>`;
    resultDiv.innerHTML=html;

    // Store for later use
    window._barcodeProduct={name,brand,categories,imageUrl,nutrition,barcode};

  }catch(e){
    console.error('Open Food Facts error:',e);
    resultDiv.innerHTML='';
    toast('‚ùå Erro ao buscar produto. Tente novamente.',3000);
  }
}

function applyBarcodeProduct(){
  const p=window._barcodeProduct;if(!p)return;

  // Guess category from OFF categories
  const catStr=(p.categories||'').toLowerCase();
  let cat='outros';
  if(catStr.match(/lait|leite|dairy|l√°cteo|queijo|iogurte|yogurt|cheese/))cat='laticinios';
  else if(catStr.match(/carne|meat|frango|chicken|peixe|fish|salsich|presunto/))cat='carnes';
  else if(catStr.match(/fruit|frut|legum|veget|hort|salad/))cat='hortifruti';
  else if(catStr.match(/p√£o|bread|padaria|bolo|cake|biscoito|cookie/))cat='padaria';
  else if(catStr.match(/enlat|canned|conserv|molho|sauce/))cat='enlatados';
  else if(catStr.match(/higien|soap|shampoo|dentifr√≠cio/))cat='higiene';

  openAddModal();
  document.getElementById('fName').value=p.name+(p.brand?' ‚Äî '+p.brand:'');
  document.getElementById('fCategory').value=cat;
  if(p.brand)document.getElementById('fNotes').value='Marca: '+p.brand+(p.barcode?'\nC√≥digo: '+p.barcode:'');

  // Show nutrition in modal
  if(p.nutrition&&(p.nutrition.calories||p.nutrition.proteins)){
    const ns=document.getElementById('nutritionSection');
    ns.classList.add('visible');
    document.getElementById('nutCalories').textContent=p.nutrition.calories||'-';
    document.getElementById('nutProteins').textContent=p.nutrition.proteins||'-';
    document.getElementById('nutCarbs').textContent=p.nutrition.carbs||'-';
    document.getElementById('nutFat').textContent=p.nutrition.fat||'-';
    window._barcodeNutrition=p.nutrition;
  }

  // Download product image
  if(p.imageUrl){
    document.getElementById('photoPreview').src=p.imageUrl;
    document.getElementById('photoPreview').style.display='block';
  }

  document.getElementById('nlResult').innerHTML='';
  toast('‚úÖ Produto preenchido via c√≥digo de barras!');
}

// Override saveItem to include nutrition
const _origSaveItem=saveItem;

// ===== SERVICE WORKER =====
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')).catch(e=>console.log('SW error',e));
}

// ===== NOTIFICATIONS CHECK =====
function checkNotifications(){checkAndNotify()}

// ===== INIT =====
function checkUrlImport(){
  const params=new URLSearchParams(location.search);
  const b64=params.get('import');
  if(!b64)return;
  try{
    const json=decodeURIComponent(escape(atob(b64)));
    const data=JSON.parse(json);
    if(data.items&&Array.isArray(data.items)){
      const existingNames=new Set(state.items.map(i=>i.name.toLowerCase()));
      let added=0;
      data.items.forEach(item=>{
        if(!existingNames.has(item.name.toLowerCase())){
          item.id=Date.now().toString(36)+Math.random().toString(36).slice(2,7);
          state.items.push(item);
          existingNames.add(item.name.toLowerCase());
          added++;
        }
      });
      save();
      toast(`üì• ${added} itens importados!`);
      history.replaceState(null,'',location.pathname);
    }
  }catch(e){console.error('Import error:',e)}
}
function init(){
  document.body.classList.toggle('light',!state.settings.darkMode);
  document.getElementById('themeBtn').textContent=state.settings.darkMode?'üåô':'‚òÄÔ∏è';
  checkUrlImport();
  renderHome();
  checkNotifications();
  setInterval(checkNotifications,3600000);
  // Require login on startup
  if(!isLoggedIn())showAuthScreen();
}
init();
</script>
</body>
</html>
